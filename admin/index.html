<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIèµ„è®¯å¹³å°ç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/amis@6.13.0/sdk/sdk.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/amis@6.13.0/sdk/sdk.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #root {
            height: 100%;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        function isLoggedIn() {
            return localStorage.getItem('admin_logged_in') === 'true';
        }

        // ç™»å‡ºå‡½æ•°
        function logout() {
            // åœæ­¢tokenè¿‡æœŸæ£€æŸ¥
            stopTokenExpiryCheck();
            
            // æ¸…é™¤localStorageä¸­çš„è®¤è¯ä¿¡æ¯
            localStorage.removeItem('admin_logged_in');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('token_expiry');
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¿‡æœŸæç¤ºå¼¹çª—
            const expiredModal = document.getElementById('token-expired-modal');
            if (expiredModal) {
                expiredModal.remove();
            }
            
            renderLoginPage();
        }

        // JWT Tokenè§£æå’ŒéªŒè¯å‡½æ•°
        function parseJWT(token) {
            try {
                // JWT tokenç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨ç‚¹å·åˆ†éš”
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // è§£æpayloadéƒ¨åˆ†ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰
                const payload = parts[1];
                // Base64 URLè§£ç 
                const base64Url = payload.replace(/-/g, '+').replace(/_/g, '/');
                const base64 = base64Url.replace(/[^A-Za-z0-9+/]/g, '');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('JWTè§£æé”™è¯¯:', error);
                return null;
            }
        }

        // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
        function isTokenExpired(token) {
            if (!token) {
                return true;
            }
            
            const decoded = parseJWT(token);
            if (!decoded || !decoded.exp) {
                return true;
            }
            
            // expæ˜¯Unixæ—¶é—´æˆ³ï¼ˆç§’ï¼‰ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
            const expiryTime = decoded.exp * 1000;
            const currentTime = Date.now();
            
            // æå‰5åˆ†é’Ÿåˆ¤æ–­ä¸ºè¿‡æœŸï¼Œç»™åˆ·æ–°ç•™å‡ºæ—¶é—´
            const bufferTime = 5 * 60 * 1000;
            
            return currentTime >= (expiryTime - bufferTime);
        }

        // è·å–tokenå‰©ä½™æœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
        function getTokenExpiryMinutes(token) {
            if (!token) {
                return 0;
            }
            
            const decoded = parseJWT(token);
            if (!decoded || !decoded.exp) {
                return 0;
            }
            
            const expiryTime = decoded.exp * 1000;
            const currentTime = Date.now();
            const remainingTime = expiryTime - currentTime;
            
            return Math.max(0, Math.floor(remainingTime / (60 * 1000)));
        }

        // å¢å¼ºçš„ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼ŒåŒ…å«tokenè¿‡æœŸæ£€æµ‹
        function isLoggedIn() {
            const loggedIn = localStorage.getItem('admin_logged_in') === 'true';
            const token = localStorage.getItem('admin_token');
            
            if (!loggedIn || !token) {
                return false;
            }
            
            // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
            if (isTokenExpired(token)) {
                console.log('Tokenå·²è¿‡æœŸï¼Œè‡ªåŠ¨ç™»å‡º');
                logout();
                return false;
            }
            
            return true;
        }

        // æ˜¾ç¤ºtokenè¿‡æœŸæé†’
        function showTokenExpiryWarning() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                return;
            }
            
            const remainingMinutes = getTokenExpiryMinutes(token);
            
            // å¦‚æœå‰©ä½™æ—¶é—´å°‘äº30åˆ†é’Ÿï¼Œæ˜¾ç¤ºæé†’
            if (remainingMinutes > 0 && remainingMinutes <= 30) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'token-expiry-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 12px 20px;
                    border-radius: 6px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    z-index: 9999;
                    font-size: 14px;
                    max-width: 300px;
                `;
                
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span>âš ï¸ ç™»å½•å³å°†åœ¨ ${remainingMinutes} åˆ†é’Ÿåè¿‡æœŸ</span>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 16px; cursor: pointer; margin-left: 10px;">Ã—</button>
                    </div>
                `;
                
                // é¿å…é‡å¤æ·»åŠ 
                if (!document.getElementById('token-expiry-warning')) {
                    document.body.appendChild(warningDiv);
                    
                    // 5åˆ†é’Ÿåè‡ªåŠ¨ç§»é™¤æé†’
                    setTimeout(() => {
                        const warning = document.getElementById('token-expiry-warning');
                        if (warning) {
                            warning.remove();
                        }
                    }, 5 * 60 * 1000);
                }
            }
        }

        // å¤„ç†401æœªæˆæƒå“åº”ï¼ˆtokenè¿‡æœŸæˆ–æ— æ•ˆï¼‰
        function handleUnauthorizedResponse() {
            console.log('æ”¶åˆ°401æœªæˆæƒå“åº”ï¼Œtokenå¯èƒ½å·²è¿‡æœŸ');
            
            // æ˜¾ç¤ºå‹å¥½çš„è¿‡æœŸæç¤º
            const expiryDiv = document.createElement('div');
            expiryDiv.id = 'token-expired-modal';
            expiryDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            expiryDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; text-align: center; max-width: 400px;">
                    <h3 style="color: #dc3545; margin-top: 0;">ğŸ”’ ç™»å½•å·²è¿‡æœŸ</h3>
                    <p style="margin: 15px 0; color: #666;">æ‚¨çš„ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨ç®¡ç†åå°ã€‚</p>
                    <button onclick="logout(); this.closest('#token-expired-modal').remove();" 
                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        é‡æ–°ç™»å½•
                    </button>
                </div>
            `;
            
            document.body.appendChild(expiryDiv);
        }

        // å…¨å±€fetcheré…ç½®ï¼Œæ·»åŠ è®¤è¯å¤´å’Œ401å¤„ç†
        const fetcher = (config) => {
            console.log('Fetcherè¢«è°ƒç”¨ï¼Œé…ç½®:', config);
            
            // åœ¨å‘é€è¯·æ±‚å‰æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
            const token = localStorage.getItem('admin_token');
            if (token && isTokenExpired(token)) {
                console.log('Tokenå·²è¿‡æœŸï¼Œé˜»æ­¢APIè¯·æ±‚');
                handleUnauthorizedResponse();
                return Promise.reject(new Error('Token expired'));
            }
            
            console.log('ä»localStorageè·å–çš„ä»¤ç‰Œ:', token);
            if (token) {
                config.headers = config.headers || {};
                config.headers['Authorization'] = `Bearer ${token}`;
                console.log('æ·»åŠ äº†è®¤è¯å¤´:', config.headers['Authorization']);
            } else {
                console.log('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œ');
            }
            console.log('æœ€ç»ˆå‘é€çš„é…ç½®:', config);
            
            // ä½¿ç”¨axioså‘é€è¯·æ±‚
            return amisRequire('axios')(config)
                .then(response => {
                    console.log('APIå“åº”:', response);
                    return response;
                })
                .catch(error => {
                    console.error('APIé”™è¯¯:', error);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯401æœªæˆæƒé”™è¯¯
                    if (error.response && error.response.status === 401) {
                        console.log('æ”¶åˆ°401å“åº”ï¼Œå¤„ç†tokenè¿‡æœŸ');
                        handleUnauthorizedResponse();
                    }
                    
                    throw error;
                });
        };
        
        // æ¸²æŸ“ç™»å½•é¡µé¢
        function renderLoginPage() {
            const loginPageConfig = {
                type: 'page',
                title: 'AIèµ„è®¯å¹³å°ç®¡ç†åå° - ç™»å½•',
                body: {
                    type: 'form',
                    api: {
                        url: '/api/auth/admin-login',
                        method: 'post',
                        adaptor: function (payload, response) {
                            console.log('ç™»å½•è¯·æ±‚å‘é€çš„æ•°æ®:', payload);
                            console.log('åç«¯è¿”å›çš„å“åº”:', response);
                            // è·å–å®é™…çš„å“åº”æ•°æ®
                            const responseData = response.data || response;
                            console.log('å®é™…å“åº”æ•°æ®:', responseData);
                            // æ£€æŸ¥ç™»å½•æ˜¯å¦æˆåŠŸ
                            if (responseData.message === "ç®¡ç†å‘˜ç™»å½•æˆåŠŸ") {
                                console.log('ç™»å½•æˆåŠŸ');
                                // ç™»å½•æˆåŠŸï¼Œä¿å­˜ä»¤ç‰Œ
                                localStorage.setItem('admin_logged_in', 'true');
                                localStorage.setItem('admin_token', responseData.token);
                                
                                // è§£ætokenå¹¶å­˜å‚¨è¿‡æœŸæ—¶é—´
                                const decodedToken = parseJWT(responseData.token);
                                if (decodedToken && decodedToken.exp) {
                                    const expiryTime = decodedToken.exp * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
                                    localStorage.setItem('token_expiry', expiryTime.toString());
                                    console.log('Tokenè¿‡æœŸæ—¶é—´:', new Date(expiryTime).toLocaleString());
                                }
                                
                                // å¯åŠ¨tokenè¿‡æœŸæ£€æŸ¥å®šæ—¶å™¨
                                startTokenExpiryCheck();
                                
                                // é‡æ–°æ¸²æŸ“ä¸»é¡µé¢
                                setTimeout(() => {
                                    renderMainPage();
                                }, 100);
                                return {
                                    status: 0,
                                    msg: 'ç™»å½•æˆåŠŸ',
                                    data: {
                                        token: responseData.token
                                    }
                                };
                            } else {
                                console.log('ç™»å½•å¤±è´¥');
                                return {
                                    status: 1,
                                    msg: responseData.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
                                };
                            }
                        }
                    },
                    redirect: '',
                    body: [
                        {
                            type: 'input-text',
                            name: 'username',
                            label: 'ç”¨æˆ·å',
                            required: true,
                            placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å'
                        },
                        {
                            type: 'input-password',
                            name: 'password',
                            label: 'å¯†ç ',
                            required: true,
                            placeholder: 'è¯·è¾“å…¥å¯†ç '
                        }
                    ],
                    actions: [
                        {
                            type: 'submit',
                            label: 'ç™»å½•',
                            level: 'primary'
                        }
                    ]
                }
            };

            const amis = amisRequire('amis/embed');
            amis.embed('#root', loginPageConfig, {}, fetcher);
        }

        // æ¸²æŸ“ä¸»é¡µé¢ - ä½¿ç”¨æ¡ä»¶æ¸²æŸ“ä½†é¿å…é‡å¤è¯·æ±‚
        function renderMainPage() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„è®¤è¯ä»¤ç‰Œ
            const token = localStorage.getItem('admin_token');
            console.log('æ¸²æŸ“ä¸»é¡µé¢æ—¶æ£€æŸ¥ä»¤ç‰Œ:', token);
            if (!token) {
                console.log('æœªæ‰¾åˆ°ä»¤ç‰Œï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
                renderLoginPage();
                return;
            }
            console.log('æ‰¾åˆ°ä»¤ç‰Œï¼Œæ¸²æŸ“ä¸»é¡µé¢');
            
            // è·å–å½“å‰Hashè·¯å¾„
            const hashPath = window.location.hash.substring(1) || '/home';
            console.log('å½“å‰Hashè·¯å¾„:', hashPath);
            
            // æ„å»ºä¸»é¡µé¢é…ç½® - ä½¿ç”¨æ¡ä»¶æ¸²æŸ“é¿å…é‡å¤åˆå§‹åŒ–
            const mainPageConfig = {
                type: 'page',
                title: 'AIèµ„è®¯å¹³å°ç®¡ç†åå°',
                toolbar: {
                    type: 'tpl',
                    tpl: '<div class="pull-right"><button class="btn btn-link" onclick="logout()">ç™»å‡º</button></div>'
                },
                body: {
                    type: 'grid',
                    columns: [
                        {
                            md: 3,
                            body: {
                                type: 'wrapper',
                                className: 'bg-light padder-v',
                                body: {
                                    type: 'nav',
                                    stacked: true,
                                    className: 'nav-pills nav-stacked',
                                    links: [
                                        {
                                            label: 'é¦–é¡µ',
                                            icon: 'fa fa-home',
                                            to: '#/home',
                                            active: hashPath === '/home'
                                        },
                                        {
                                            label: 'ç”¨æˆ·ç®¡ç†',
                                            icon: 'fa fa-users',
                                            to: '#/users',
                                            active: hashPath === '/users'
                                        },
                                        {
                                            label: 'RSSæºç®¡ç†',
                                            icon: 'fa fa-rss',
                                            to: '#/sources',
                                            active: hashPath === '/sources'
                                        },
                                        {
                                            label: 'å†…å®¹ç®¡ç†',
                                            icon: 'fa fa-newspaper-o',
                                            to: '#/contents',
                                            active: hashPath === '/contents'
                                        },
                                        {
                                            label: 'ç³»ç»Ÿç›‘æ§',
                                            icon: 'fa fa-dashboard',
                                            to: '#/system',
                                            active: hashPath === '/system'
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            md: 9,
                            body: [
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/home"`,
                                    body: getHomePageConfig().body
                                },
                                {
                                    type: 'wrapper', 
                                    visibleOn: `window.location.hash === "#/users"`,
                                    body: getUsersPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/sources"`, 
                                    body: getSourcesPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/contents"`,
                                    body: getContentsPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/system"`,
                                    body: getSystemPageConfig().body
                                }
                            ]
                        }
                    ]
                }
            };

            console.log('ä¸»é¡µé¢é…ç½®:', mainPageConfig);
            console.log('å¼€å§‹æ¸²æŸ“amisé¡µé¢...');
            
            // æ¸…ç†ä¹‹å‰çš„å®ä¾‹ï¼Œé¿å…å†…å­˜æ³„æ¼
            const rootElement = document.getElementById('root');
            if (window.amisInstance) {
                try {
                    console.log('é”€æ¯æ—§amiså®ä¾‹');
                    window.amisInstance.destroy();
                } catch (e) {
                    console.log('é”€æ¯æ—§å®ä¾‹æ—¶å‡ºé”™:', e);
                }
            }
            
            // æ¸…ç©ºDOM
            rootElement.innerHTML = '';
            
            // æ¸²æŸ“æ–°å®ä¾‹
            const amis = amisRequire('amis/embed');
            window.amisInstance = amis.embed('#root', mainPageConfig, {}, fetcher);
            
            console.log('amisé¡µé¢æ¸²æŸ“å®Œæˆ:', window.amisInstance);
            
            // åªæœ‰åˆæ¬¡åŠ è½½æ‰è®¾ç½®é»˜è®¤Hashï¼Œé¿å…å¾ªç¯
            if (!window.location.hash || window.location.hash === '#') {
                window.location.hash = '#/home';
            }
        }
        
        // é¦–é¡µé…ç½®
        function getHomePageConfig() {
            return {
                type: 'page',
                title: 'é¦–é¡µ',
                body: [
                    {
                        type: 'tpl',
                        tpl: '<h3>æ¬¢è¿ä½¿ç”¨AIèµ„è®¯å¹³å°ç®¡ç†åå°</h3><p>è¯·é€‰æ‹©å·¦ä¾§èœå•è¿›è¡Œæ“ä½œ</p>',
                        inline: false
                    }
                ]
            };
        }
        
        // ç”¨æˆ·ç®¡ç†é¡µé¢é…ç½®
        function getUsersPageConfig() {
            return {
                type: 'page',
                title: 'ç”¨æˆ·ç®¡ç†',
                body: {
                    type: 'service',
                    api: {
                        method: 'get',
                        url: '/admin/users/statistics',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    },
                    body: [
                        {
                            type: 'grid',
                            columns: [
                                {
                                    type: 'panel',
                                    title: 'ç”¨æˆ·æ€»æ•°',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${totalUsers}</h2><p>ç”¨æˆ·</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: 'æ´»è·ƒç”¨æˆ·',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${activeUsers}</h2><p>æ´»è·ƒ</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: 'å¾…å®¡æ ¸ç”¨æˆ·',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${pendingUsers}</h2><p>å¾…å®¡æ ¸</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: 'è¿‘æœŸæ³¨å†Œ',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${recentRegistrations}</h2><p>7å¤©å†…</p>'
                                    }
                                }
                            ]
                        },
                        {
                            type: 'crud',
                            api: {
                                method: 'get',
                                url: '/admin/users',
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                }
                            },
                            defaultParams: {
                                limit: 20
                            },
                            pageField: 'page',
                            perPageField: 'limit',
                            loadDataOnce: false,
                            interval: 0,
                            silentPolling: false,
                            stopAutoRefreshWhen: 'true',
                            syncLocation: true,
                            columns: [
                                {
                                    name: 'id',
                                    label: 'ID',
                                    type: 'text',
                                    width: 60
                                },
                                {
                                    name: 'email',
                                    label: 'é‚®ç®±',
                                    type: 'text',
                                    width: 200
                                },
                                {
                                    name: 'status',
                                    label: 'çŠ¶æ€',
                                    type: 'mapping',
                                    map: {
                                        'active': '<span class="label label-success">æ´»è·ƒ</span>',
                                        'inactive': '<span class="label label-default">éæ´»è·ƒ</span>',
                                        'suspended': '<span class="label label-danger">å·²åœç”¨</span>',
                                        'pending': '<span class="label label-warning">å¾…å®¡æ ¸</span>'
                                    },
                                    width: 80
                                },
                                {
                                    name: 'role',
                                    label: 'è§’è‰²',
                                    type: 'mapping',
                                    map: {
                                        'user': '<span class="label label-default">ç”¨æˆ·</span>',
                                        'admin': '<span class="label label-info">ç®¡ç†å‘˜</span>',
                                        'super_admin': '<span class="label label-warning">è¶…çº§ç®¡ç†å‘˜</span>'
                                    },
                                    width: 80
                                },
                                {
                                    name: 'isVerified',
                                    label: 'å·²éªŒè¯',
                                    type: 'mapping',
                                    map: {
                                        '1': '<span class="label label-success">æ˜¯</span>',
                                        '0': '<span class="label label-default">å¦</span>'
                                    },
                                    width: 80
                                },
                                {
                                    name: 'loginCount',
                                    label: 'ç™»å½•æ¬¡æ•°',
                                    type: 'text',
                                    width: 80
                                },
                                {
                                    name: 'lastLoginAt',
                                    label: 'æœ€åç™»å½•',
                                    type: 'datetime',
                                    width: 150
                                },
                                {
                                    name: 'createdAt',
                                    label: 'æ³¨å†Œæ—¶é—´',
                                    type: 'datetime',
                                    width: 150
                                },
                                {
                                    type: 'operation',
                                    label: 'æ“ä½œ',
                                    width: 200,
                                    buttons: [
                                        {
                                            type: 'button',
                                            label: 'è¯¦æƒ…',
                                            level: 'info',
                                            size: 'xs',
                                            icon: 'fa fa-eye',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: 'ç”¨æˆ·è¯¦æƒ… - ${email}',
                                                size: 'lg',
                                                body: {
                                                    type: 'service',
                                                    api: {
                                                        method: 'get',
                                                        url: '/admin/users/${id}',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: {
                                                        type: 'tabs',
                                                        tabs: [
                                                            {
                                                                title: 'åŸºæœ¬ä¿¡æ¯',
                                                                body: {
                                                                    type: 'form',
                                                                    mode: 'normal',
                                                                    body: [
                                                                        {
                                                                            type: 'static',
                                                                            name: 'id',
                                                                            label: 'ID'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'email',
                                                                            label: 'é‚®ç®±'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'status',
                                                                            label: 'çŠ¶æ€',
                                                                            tpl: '${status === "active" ? "æ´»è·ƒ" : status === "inactive" ? "éæ´»è·ƒ" : status === "suspended" ? "å·²åœç”¨" : "å¾…å®¡æ ¸"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'role',
                                                                            label: 'è§’è‰²',
                                                                            tpl: '${role === "user" ? "ç”¨æˆ·" : role === "admin" ? "ç®¡ç†å‘˜" : "è¶…çº§ç®¡ç†å‘˜"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'isVerified',
                                                                            label: 'å·²éªŒè¯',
                                                                            tpl: '${isVerified ? "æ˜¯" : "å¦"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'loginCount',
                                                                            label: 'ç™»å½•æ¬¡æ•°'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'lastLoginAt',
                                                                            label: 'æœ€åç™»å½•',
                                                                            format: 'YYYY-MM-DD HH:mm:ss'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'lastLoginIp',
                                                                            label: 'æœ€åç™»å½•IP'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'registeredIp',
                                                                            label: 'æ³¨å†ŒIP'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'riskLevel',
                                                                            label: 'é£é™©ç­‰çº§',
                                                                            tpl: '${riskLevel === "low" ? "ä½" : riskLevel === "medium" ? "ä¸­" : "é«˜"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'createdAt',
                                                                            label: 'æ³¨å†Œæ—¶é—´',
                                                                            format: 'YYYY-MM-DD HH:mm:ss'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'notes',
                                                                            label: 'å¤‡æ³¨'
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                title: 'è§’è‰²æƒé™',
                                                                body: {
                                                                    type: 'service',
                                                                    api: {
                                                                        method: 'get',
                                                                        url: '/admin/roles/users/${id}/roles',
                                                                        headers: {
                                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                        }
                                                                    },
                                                                    body: {
                                                                        type: 'crud',
                                                                        columns: [
                                                                            {
                                                                                name: 'name',
                                                                                label: 'è§’è‰²åç§°'
                                                                            },
                                                                            {
                                                                                name: 'description',
                                                                                label: 'è§’è‰²æè¿°'
                                                                            },
                                                                            {
                                                                                name: 'permissions',
                                                                                label: 'æƒé™',
                                                                                type: 'tpl',
                                                                                tpl: '${permissions}'
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            },
                                                            {
                                                                title: 'æ“ä½œæ—¥å¿—',
                                                                body: {
                                                                    type: 'service',
                                                                    api: {
                                                                        method: 'get',
                                                                        url: '/admin/users/${id}/logs',
                                                                        headers: {
                                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                        }
                                                                    },
                                                                    body: {
                                                                        type: 'crud',
                                                                        columns: [
                                                                            {
                                                                                name: 'operation',
                                                                                label: 'æ“ä½œç±»å‹',
                                                                                type: 'mapping',
                                                                                map: {
                                                                                    'create': 'åˆ›å»º',
                                                                                    'update': 'æ›´æ–°',
                                                                                    'delete': 'åˆ é™¤',
                                                                                    'status_change': 'çŠ¶æ€å˜æ›´',
                                                                                    'role_change': 'è§’è‰²å˜æ›´',
                                                                                    'login': 'ç™»å½•',
                                                                                    'logout': 'ç™»å‡º'
                                                                                }
                                                                            },
                                                                            {
                                                                                name: 'result',
                                                                                label: 'ç»“æœ',
                                                                                type: 'mapping',
                                                                                map: {
                                                                                    'success': '<span class="label label-success">æˆåŠŸ</span>',
                                                                                    'failure': '<span class="label label-danger">å¤±è´¥</span>'
                                                                                }
                                                                            },
                                                                            {
                                                                                name: 'ipAddress',
                                                                                label: 'IPåœ°å€'
                                                                            },
                                                                            {
                                                                                name: 'timestamp',
                                                                                label: 'æ—¶é—´',
                                                                                type: 'datetime',
                                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            type: 'button',
                                            label: 'çŠ¶æ€',
                                            level: 'warning',
                                            size: 'xs',
                                            icon: 'fa fa-toggle-on',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: 'æ›´æ”¹ç”¨æˆ·çŠ¶æ€ - ${email}',
                                                body: {
                                                    type: 'form',
                                                    api: {
                                                        method: 'put',
                                                        url: '/admin/users/${id}/status',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: [
                                                        {
                                                            type: 'select',
                                                            name: 'status',
                                                            label: 'æ–°çŠ¶æ€',
                                                            required: true,
                                                            options: [
                                                                { label: 'æ´»è·ƒ', value: 'active' },
                                                                { label: 'éæ´»è·ƒ', value: 'inactive' },
                                                                { label: 'å·²åœç”¨', value: 'suspended' },
                                                                { label: 'å¾…å®¡æ ¸', value: 'pending' }
                                                            ]
                                                        },
                                                        {
                                                            type: 'textarea',
                                                            name: 'reason',
                                                            label: 'å˜æ›´åŸå› '
                                                        }
                                                    ]
                                                }
                                            }
                                        },
                                        {
                                            type: 'button',
                                            label: 'è§’è‰²',
                                            level: 'primary',
                                            size: 'xs',
                                            icon: 'fa fa-user-tag',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: 'åˆ†é…è§’è‰² - ${email}',
                                                body: {
                                                    type: 'service',
                                                    api: {
                                                        method: 'get',
                                                        url: '/admin/roles',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: {
                                                        type: 'form',
                                                        api: {
                                                            method: 'put',
                                                            url: '/admin/users/${id}/role',
                                                            headers: {
                                                                'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                            }
                                                        },
                                                        body: [
                                                            {
                                                                type: 'select',
                                                                name: 'roleId',
                                                                label: 'é€‰æ‹©è§’è‰²',
                                                                required: true,
                                                                source: {
                                                                    method: 'get',
                                                                    url: '/admin/roles',
                                                                    headers: {
                                                                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                    },
                                                                    adaptor: function(payload, response) {
                                                                        const data = response.data || response;
                                                                        return {
                                                                            options: data.roles.map(role => ({
                                                                                label: role.name,
                                                                                value: role.id
                                                                            }))
                                                                        };
                                                                    }
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            type: 'button',
                                            label: 'ä¼šè¯',
                                            level: 'info',
                                            size: 'xs',
                                            icon: 'fa fa-laptop',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: 'ç”¨æˆ·ä¼šè¯ - ${email}',
                                                body: {
                                                    type: 'service',
                                                    api: {
                                                        method: 'get',
                                                        url: '/admin/users/${id}/sessions',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: {
                                                        type: 'crud',
                                                        columns: [
                                                            {
                                                                name: 'ipAddress',
                                                                label: 'IPåœ°å€'
                                                            },
                                                            {
                                                                name: 'userAgent',
                                                                label: 'ç”¨æˆ·ä»£ç†'
                                                            },
                                                            {
                                                                name: 'lastActivityAt',
                                                                label: 'æœ€åæ´»åŠ¨',
                                                                type: 'datetime',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            },
                                                            {
                                                                name: 'expiresAt',
                                                                label: 'è¿‡æœŸæ—¶é—´',
                                                                type: 'datetime',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            },
                                                            {
                                                                type: 'operation',
                                                                label: 'æ“ä½œ',
                                                                width: 80,
                                                                buttons: [
                                                                    {
                                                                        type: 'button',
                                                                        label: 'ä¸‹çº¿',
                                                                        level: 'danger',
                                                                        size: 'xs',
                                                                        actionType: 'ajax',
                                                                        confirmText: 'ç¡®è®¤å¼ºåˆ¶è¯¥ç”¨æˆ·ä¸‹çº¿ï¼Ÿ',
                                                                        api: {
                                                                            method: 'delete',
                                                                            url: '/admin/users/${id}/sessions/${sessionId}',
                                                                            headers: {
                                                                                'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                            }
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            ],
                            headerToolbar: [
                                {
                                    type: 'form',
                                    title: 'æœç´¢ç­›é€‰',
                                    target: 'crud',
                                    mode: 'inline',
                                    body: [
                                        {
                                            type: 'input-text',
                                            name: 'search',
                                            placeholder: 'æœç´¢é‚®ç®±...',
                                            clearable: true
                                        },
                                        {
                                            type: 'select',
                                            name: 'status',
                                            placeholder: 'çŠ¶æ€',
                                            options: [
                                                { label: 'å…¨éƒ¨', value: '' },
                                                { label: 'æ´»è·ƒ', value: 'active' },
                                                { label: 'éæ´»è·ƒ', value: 'inactive' },
                                                { label: 'å·²åœç”¨', value: 'suspended' },
                                                { label: 'å¾…å®¡æ ¸', value: 'pending' }
                                            ],
                                            clearable: true
                                        },
                                        {
                                            type: 'select',
                                            name: 'role',
                                            placeholder: 'è§’è‰²',
                                            options: [
                                                { label: 'å…¨éƒ¨', value: '' },
                                                { label: 'ç”¨æˆ·', value: 'user' },
                                                { label: 'ç®¡ç†å‘˜', value: 'admin' },
                                                { label: 'è¶…çº§ç®¡ç†å‘˜', value: 'super_admin' }
                                            ],
                                            clearable: true
                                        },
                                        {
                                            type: 'submit',
                                            label: 'æœç´¢',
                                            level: 'primary'
                                        }
                                    ]
                                },
                                {
                                    type: 'button',
                                    label: 'æ‰¹é‡æ“ä½œ',
                                    level: 'danger',
                                    icon: 'fa fa-tasks',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'æ‰¹é‡æ“ä½œ',
                                        body: {
                                            type: 'form',
                                            api: {
                                                method: 'post',
                                                url: '/admin/users/batch',
                                                headers: {
                                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                }
                                            },
                                            body: [
                                                {
                                                    type: 'select',
                                                    name: 'operation',
                                                    label: 'æ“ä½œç±»å‹',
                                                    required: true,
                                                    options: [
                                                        { label: 'æ¿€æ´»ç”¨æˆ·', value: 'activate' },
                                                        { label: 'åœç”¨ç”¨æˆ·', value: 'deactivate' },
                                                        { label: 'æš‚åœç”¨æˆ·', value: 'suspend' }
                                                    ]
                                                },
                                                {
                                                    type: 'hidden',
                                                    name: 'userIds',
                                                    value: '${selectedItems|map:item=>item.id|join:,}'
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'pagination',
                                    align: 'right'
                                }
                            ],
                            footerToolbar: [
                                'statistics',
                                {
                                    type: 'pagination',
                                    align: 'right'
                                }
                            ]
                        }
                    ]
                }
            };
        }
        
        // RSSæºç®¡ç†é¡µé¢é…ç½®
        function getSourcesPageConfig() {
            return {
                type: 'page',
                title: 'RSSæºç®¡ç†',
                body: {
                    type: 'crud',
                    api: {
                        method: 'get',
                        url: '/admin/sources',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    },
                    defaultParams: {
                        perPage: 10
                    },
                    pageField: 'page',
                    perPageField: 'perPage',
                    loadDataOnce: false, // å¯ç”¨åˆ†é¡µ
                    interval: 0, // ç¦ç”¨è½®è¯¢
                    silentPolling: false, // ç¦ç”¨é™é»˜è½®è¯¢
                    stopAutoRefreshWhen: 'true', // å§‹ç»ˆåœæ­¢è‡ªåŠ¨åˆ·æ–°
                    syncLocation: true, // å¯ç”¨URLåŒæ­¥ä»¥æ”¯æŒåˆ†é¡µ
                    columns: [
                        {
                            name: 'id',
                            label: 'ID',
                            type: 'text',
                            width: 60
                        },
                        {
                            name: 'name',
                            label: 'æºåç§°',
                            type: 'text',
                            searchable: true
                        },
                        {
                            name: 'url',
                            label: 'URL',
                            type: 'text',
                            searchable: true
                        },
                        {
                            name: 'description',
                            label: 'æè¿°',
                            type: 'text'
                        },
                        {
                            name: 'userId',
                            label: 'æ‰€å±ç”¨æˆ·',
                            type: 'text'
                        },
                        {
                            name: 'isPublic',
                            label: 'å…¬å¼€',
                            type: 'mapping',
                            map: {
                                'true': '<span class="label label-success">å…¬å¼€</span>',
                                'false': '<span class="label label-default">ç§æœ‰</span>'
                            }
                        },
                        {
                            name: 'isRecommended',
                            label: 'æ¨è',
                            type: 'mapping',
                            map: {
                                'true': '<span class="label label-info">æ¨è</span>',
                                'false': '<span class="label label-default">æ™®é€š</span>'
                            }
                        },
                        {
                            name: 'recommendationLevel',
                            label: 'æ¨èçº§åˆ«',
                            type: 'mapping',
                            map: {
                                'basic': '<span class="label label-default">åŸºç¡€</span>',
                                'premium': '<span class="label label-warning">é«˜çº§</span>',
                                'featured': '<span class="label label-purple">ç²¾é€‰</span>'
                            }
                        },
                        {
                            name: 'qualityValidationStatus',
                            label: 'éªŒè¯çŠ¶æ€',
                            type: 'mapping',
                            map: {
                                'pending': '<span class="label label-warning">å¾…éªŒè¯</span>',
                                'approved': '<span class="label label-success">å·²é€šè¿‡</span>',
                                'rejected': '<span class="label label-danger">å·²æ‹’ç»</span>'
                            }
                        },
                        {
                            name: 'qualityAvailability',
                            label: 'å¯ç”¨æ€§',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'qualityContentQuality',
                            label: 'å†…å®¹è´¨é‡',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'fetchFailureCount',
                            label: 'å¤±è´¥æ¬¡æ•°',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'lastFetchedAt',
                            label: 'ä¸Šæ¬¡è·å–',
                            type: 'datetime',
                            format: 'YYYY-MM-DD HH:mm:ss'
                        },
                        {
                            name: 'statisticsTotalSubscribers',
                            label: 'æ€»è®¢é˜…',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'createdAt',
                            label: 'åˆ›å»ºæ—¶é—´',
                            type: 'datetime',
                            format: 'YYYY-MM-DD HH:mm:ss'
                        },
                        {
                            type: 'operation',
                            label: 'æ“ä½œ',
                            width: 260,
                            buttons: [
                                {
                                    label: 'æŸ¥çœ‹è¯¦æƒ…',
                                    type: 'button',
                                    level: 'primary',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'RSSæºè¯¦æƒ…',
                                        body: {
                                            type: 'form',
                                            static: true,
                                            body: [
                                                {
                                                    type: 'static',
                                                    name: 'id',
                                                    label: 'ID'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'name',
                                                    label: 'åç§°'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'url',
                                                    label: 'URL'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'description',
                                                    label: 'æè¿°'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'userId',
                                                    label: 'æ‰€å±ç”¨æˆ·ID'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'isPublic',
                                                    label: 'æ˜¯å¦å…¬å¼€'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'isRecommended',
                                                    label: 'æ˜¯å¦æ¨è'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'recommendationLevel',
                                                    label: 'æ¨èçº§åˆ«'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityAvailability',
                                                    label: 'å¯ç”¨æ€§è¯„åˆ†'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityContentQuality',
                                                    label: 'å†…å®¹è´¨é‡è¯„åˆ†'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityUpdateFrequency',
                                                    label: 'æ›´æ–°é¢‘ç‡è¯„åˆ†'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityValidationStatus',
                                                    label: 'éªŒè¯çŠ¶æ€'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'fetchFailureCount',
                                                    label: 'è·å–å¤±è´¥æ¬¡æ•°'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'statisticsTotalSubscribers',
                                                    label: 'æ€»è®¢é˜…æ•°'
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    label: 'æ‰‹åŠ¨è·å–',
                                    type: 'button',
                                    level: 'info',
                                    actionType: 'ajax',
                                    api: {
                                        method: 'post',
                                        url: '/api/sources/${id}/trigger-fetch',
                                        headers: {
                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                        }
                                    },
                                    confirmText: 'ç¡®å®šè¦æ‰‹åŠ¨è§¦å‘æ­¤RSSæºçš„è·å–å—ï¼Ÿ'
                                },
                                {
                                    type: 'button',
                                    label: 'å†…å®¹',
                                    level: 'info',
                                    size: 'xs',
                                    icon: 'fa fa-list',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'RSSå†…å®¹åˆ—è¡¨ - ${name}',
                                        size: 'xl',
                                        body: {
                                            type: 'crud',
                                            api: {
                                                method: 'get',
                                                url: '/api/sources/${id}/entries',
                                                headers: {
                                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                }
                                            },
                                            defaultParams: {
                                                perPage: 10
                                            },
                                            pageField: 'page',
                                            perPageField: 'perPage',
                                            interval: 0, // ç¦ç”¨è½®è¯¢
                                            silentPolling: false,
                                            stopAutoRefreshWhen: 'true',
                                            syncLocation: true, // å¯ç”¨URLåŒæ­¥ä»¥æ”¯æŒåˆ†é¡µ
                                            columns: [
                                                {
                                                    name: 'id',
                                                    label: 'ID',
                                                    type: 'text',
                                                    width: 60
                                                },
                                                {
                                                    name: 'title',
                                                    label: 'æ ‡é¢˜',
                                                    type: 'text'
                                                },
                                                {
                                                    name: 'publishedAt',
                                                    label: 'å‘å¸ƒæ—¶é—´',
                                                    type: 'datetime',
                                                    width: 150
                                                },
                                                {
                                                    name: 'processed',
                                                    label: 'å¤„ç†çŠ¶æ€',
                                                    type: 'mapping',
                                                    map: {
                                                        '1': '<span class="label label-success">å·²å¤„ç†</span>',
                                                        '0': '<span class="label label-warning">æœªå¤„ç†</span>'
                                                    },
                                                    width: 100
                                                },
                                                {
                                                    name: 'failureCount',
                                                    label: 'å¤±è´¥æ¬¡æ•°',
                                                    type: 'text',
                                                    width: 80
                                                },
                                                {
                                                    type: 'operation',
                                                    label: 'æ“ä½œ',
                                                    width: 80,
                                                    buttons: [
                                                        {
                                                            type: 'button',
                                                            label: 'è¯¦æƒ…',
                                                            level: 'link',
                                                            size: 'xs',
                                                            actionType: 'dialog',
                                                            dialog: {
                                                                title: 'å†…å®¹è¯¦æƒ… - ${title}',
                                                                size: 'lg',
                                                                body: {
                                                                    type: 'form',
                                                                    mode: 'normal',
                                                                    body: [
                                                                        {
                                                                            type: 'static',
                                                                            name: 'title',
                                                                            label: 'æ ‡é¢˜'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'link',
                                                                            label: 'é“¾æ¥'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'publishedAt',
                                                                            label: 'å‘å¸ƒæ—¶é—´',
                                                                            format: 'YYYY-MM-DD HH:mm:ss'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'processed',
                                                                            label: 'å¤„ç†çŠ¶æ€',
                                                                            tpl: '${processed ? "å·²å¤„ç†" : "æœªå¤„ç†"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'content',
                                                                            label: 'å†…å®¹',
                                                                            tpl: '<div style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${content}</div>'
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'button',
                                    label: 'ç¼–è¾‘',
                                    level: 'warning',
                                    size: 'xs',
                                    icon: 'fa fa-edit',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'ç¼–è¾‘RSSæº',
                                        body: {
                                            type: 'form',
                                            api: {
                                                method: 'put',
                                                url: '/api/sources/${id}',
                                                headers: {
                                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                }
                                            },
                                            body: [
                                                {
                                                    type: 'input-text',
                                                    name: 'name',
                                                    label: 'åç§°',
                                                    required: true
                                                },
                                                {
                                                    type: 'input-text',
                                                    name: 'url',
                                                    label: 'URL',
                                                    required: true
                                                },
                                                {
                                                    type: 'input-text',
                                                    name: 'description',
                                                    label: 'æè¿°'
                                                },
                                                {
                                                    type: 'switch',
                                                    name: 'isPublic',
                                                    label: 'æ˜¯å¦å…¬å¼€',
                                                    trueValue: true,
                                                    falseValue: false
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'button',
                                    label: 'åˆ é™¤',
                                    level: 'danger',
                                    size: 'xs',
                                    icon: 'fa fa-trash',
                                    actionType: 'ajax',
                                    confirmText: 'æ‚¨ç¡®è®¤è¦åˆ é™¤è¯¥RSSæº?',
                                    api: {
                                        method: 'delete',
                                        url: '/api/sources/${id}',
                                        headers: {
                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                        }
                                    },
                                    feedback: {
                                        title: 'åˆ é™¤æˆåŠŸ',
                                        body: 'RSSæºå·²æˆåŠŸåˆ é™¤'
                                    }
                                }
                            ]
                        }
                    ],
                    filter: {
                        title: 'æœç´¢ç­›é€‰',
                        submitText: 'æœç´¢',
                        controls: [
                            {
                                type: 'text',
                                name: 'search',
                                label: 'æœç´¢',
                                placeholder: 'æœç´¢åç§°ã€URLæˆ–æè¿°'
                            },
                            {
                                type: 'select',
                                name: 'isRecommended',
                                label: 'æ¨èçŠ¶æ€',
                                options: [
                                    { label: 'å…¨éƒ¨', value: '' },
                                    { label: 'æ¨èæº', value: 'true' },
                                    { label: 'æ™®é€šæº', value: 'false' }
                                ]
                            },
                            {
                                type: 'select',
                                name: 'qualityValidationStatus',
                                label: 'éªŒè¯çŠ¶æ€',
                                options: [
                                    { label: 'å…¨éƒ¨', value: '' },
                                    { label: 'å¾…éªŒè¯', value: 'pending' },
                                    { label: 'å·²é€šè¿‡', value: 'approved' },
                                    { label: 'å·²æ‹’ç»', value: 'rejected' }
                                ]
                            },
                            {
                                type: 'text',
                                name: 'userId',
                                label: 'ç”¨æˆ·ID',
                                placeholder: 'è¾“å…¥ç”¨æˆ·ID'
                            }
                        ]
                    },
                    features: ['filter', 'create', 'update', 'delete'],
                    headerToolbar: [
                        {
                            type: 'reload',
                            label: 'åˆ·æ–°',
                            icon: 'fa fa-refresh'
                        },
                        {
                            type: 'columns-toggler',
                            label: 'åˆ—æ˜¾ç¤º',
                            icon: 'fa fa-columns'
                        }
                    ],
                    footerToolbar: [
                        'statistics',
                        {
                            type: 'pagination',
                            align: 'right'
                        }
                    ]
                }
            };
        }
        
        // ç³»ç»Ÿç›‘æ§é¡µé¢é…ç½®
        function getSystemPageConfig() {
            return {
                type: 'page',
                title: 'ç³»ç»Ÿç›‘æ§',
                body: {
                    type: 'service',
                    api: {
                        method: 'get',
                        url: '/system/stats',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        },
                        cache: 0 // ç¦ç”¨ç¼“å­˜
                    },
                    interval: 0, // ç¦ç”¨è½®è¯¢
                    body: [
                        {
                            type: 'grid',
                            columns: [
                                {
                                    type: 'panel',
                                    title: 'ç”¨æˆ·æ€»æ•°',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${userCount}</h2><p>ç”¨æˆ·</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: 'RSSæºæ€»æ•°',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${sourceCount}</h2><p>RSSæº</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: 'å¤±è´¥æºæ•°é‡',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${failedSourceCount}</h2><p>å¤±è´¥æº</p>'
                                    }
                                }
                            ]
                        }
                    ]
                }
            };
        }
        
        // å†…å®¹ç®¡ç†é¡µé¢é…ç½®
        function getContentsPageConfig() {
            return {
                type: 'page',
                title: 'å†…å®¹ç®¡ç†',
                body: {
                    type: 'crud',
                    api: {
                        method: 'get',
                        url: '/sources/entries/all',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    },
                    defaultParams: {
                        perPage: 20
                    },
                    pageField: 'page',
                    perPageField: 'perPage',
                    interval: 0, // ç¦ç”¨è½®è¯¢
                    silentPolling: false,
                    stopAutoRefreshWhen: 'true',
                    syncLocation: true, // å¯ç”¨URLåŒæ­¥ä»¥æ”¯æŒåˆ†é¡µ
                    columns: [
                        {
                            name: 'id',
                            label: 'ID',
                            type: 'text',
                            width: 60
                        },
                        {
                            name: 'sourceName',
                            label: 'RSSæº',
                            type: 'text',
                            width: 120
                        },
                        {
                            name: 'title',
                            label: 'æ ‡é¢˜',
                            type: 'text'
                        },
                        {
                            name: 'content',
                            label: 'å†…å®¹é¢„è§ˆ',
                            type: 'text',
                            width: 200
                        },
                        {
                            name: 'publishedAt',
                            label: 'å‘å¸ƒæ—¶é—´',
                            type: 'datetime',
                            width: 150
                        },
                        {
                            name: 'processed',
                            label: 'å¤„ç†çŠ¶æ€',
                            type: 'mapping',
                            map: {
                                '1': '<span class="label label-success">å·²å¤„ç†</span>',
                                '0': '<span class="label label-warning">æœªå¤„ç†</span>'
                            },
                            width: 100
                        },
                        {
                            name: 'failureCount',
                            label: 'å¤±è´¥æ¬¡æ•°',
                            type: 'text',
                            width: 80
                        },
                        {
                            type: 'operation',
                            label: 'æ“ä½œ',
                            width: 120,
                            buttons: [
                                {
                                    type: 'button',
                                    label: 'è¯¦æƒ…',
                                    level: 'info',
                                    size: 'xs',
                                    icon: 'fa fa-eye',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'å†…å®¹è¯¦æƒ… - ${title}',
                                        size: 'xl',
                                        body: {
                                            type: 'tabs',
                                            tabs: [
                                                {
                                                    title: 'åŸºæœ¬ä¿¡æ¯',
                                                    body: {
                                                        type: 'form',
                                                        mode: 'normal',
                                                        body: [
                                                            {
                                                                type: 'static',
                                                                name: 'id',
                                                                label: 'ID'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'sourceName',
                                                                label: 'RSSæº'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'title',
                                                                label: 'æ ‡é¢˜'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'link',
                                                                label: 'é“¾æ¥',
                                                                tpl: '<a href="${link}" target="_blank">${link}</a>'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'publishedAt',
                                                                label: 'å‘å¸ƒæ—¶é—´',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'processed',
                                                                label: 'å¤„ç†çŠ¶æ€',
                                                                tpl: '${processed ? "å·²å¤„ç†" : "æœªå¤„ç†"}'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'failureCount',
                                                                label: 'å¤±è´¥æ¬¡æ•°'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'errorMessage',
                                                                label: 'é”™è¯¯ä¿¡æ¯',
                                                                visibleOn: '${errorMessage}',
                                                                tpl: '<span class="text-danger">${errorMessage}</span>'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'createdAt',
                                                                label: 'æŠ“å–æ—¶é—´',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            }
                                                        ]
                                                    }
                                                },
                                                {
                                                    title: 'åŸå§‹å†…å®¹',
                                                    body: {
                                                        type: 'form',
                                                        mode: 'normal',
                                                        body: [
                                                            {
                                                                type: 'static',
                                                                name: 'content',
                                                                label: 'å†…å®¹',
                                                                tpl: '<div style="max-height: 500px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9;">${content|raw}</div>'
                                                            }
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'button',
                                    label: 'è®¿é—®',
                                    level: 'success',
                                    size: 'xs',
                                    icon: 'fa fa-external-link',
                                    actionType: 'url',
                                    url: '${link}',
                                    blank: true
                                }
                            ]
                        }
                    ],
                    headerToolbar: [
                        {
                            type: 'columns-toggler',
                            align: 'left'
                        },
                        {
                            type: 'drag-toggler',
                            align: 'left'
                        },
                        {
                            type: 'pagination',
                            align: 'right'
                        }
                    ],
                    footerToolbar: [
                        'statistics',
                        {
                            type: 'pagination',
                            align: 'right'
                        }
                    ]
                }
            };
        }

        // å…¨å±€ç™»å‡ºå‡½æ•°
        window.logout = logout;

        // å¯åŠ¨tokenè¿‡æœŸæ£€æŸ¥å®šæ—¶å™¨
        let tokenCheckInterval;
        function startTokenExpiryCheck() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (tokenCheckInterval) {
                clearInterval(tokenCheckInterval);
            }
            
            // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡tokençŠ¶æ€
            tokenCheckInterval = setInterval(() => {
                if (isLoggedIn()) {
                    // æ˜¾ç¤ºè¿‡æœŸæé†’ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    showTokenExpiryWarning();
                } else {
                    // å¦‚æœå·²ç»ç™»å‡ºï¼Œåœæ­¢æ£€æŸ¥
                    clearInterval(tokenCheckInterval);
                }
            }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            showTokenExpiryWarning();
        }

        // åœæ­¢tokenè¿‡æœŸæ£€æŸ¥
        function stopTokenExpiryCheck() {
            if (tokenCheckInterval) {
                clearInterval(tokenCheckInterval);
                tokenCheckInterval = null;
            }
            
            // ç§»é™¤è¿‡æœŸæé†’
            const warning = document.getElementById('token-expiry-warning');
            if (warning) {
                warning.remove();
            }
        }

        // Hashå˜åŒ–ç›‘å¬å™¨ - é‡æ–°æ¸²æŸ“é¡µé¢ä»¥è§¦å‘amisçš„visibleOné‡æ–°è®¡ç®—
        function handleHashChange() {
            console.log('Hashå˜åŒ–æ£€æµ‹:', window.location.hash);
            // éœ€è¦é‡æ–°æ¸²æŸ“amiså®ä¾‹æ‰èƒ½è®©visibleOné‡æ–°è®¡ç®—
            renderMainPage();
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            stopTokenExpiryCheck();
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åˆå§‹åŒ–
        if (isLoggedIn()) {
            console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œåˆå§‹åŒ–ä¸»é¡µé¢');
            renderMainPage();
            
            // ç»‘å®šHashå˜åŒ–ç›‘å¬å™¨
            console.log('ç»‘å®šHashå˜åŒ–ç›‘å¬å™¨');
            window.addEventListener('hashchange', handleHashChange);
            
            // å¯åŠ¨tokenè¿‡æœŸæ£€æŸ¥
            console.log('å¯åŠ¨tokenè¿‡æœŸæ£€æŸ¥');
            startTokenExpiryCheck();
        } else {
            console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢');
            renderLoginPage();
        }
    </script>
</body>
</html>