<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI资讯平台管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/amis@6.13.0/sdk/sdk.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/amis@6.13.0/sdk/sdk.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #root {
            height: 100%;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        // 检查是否已登录
        function isLoggedIn() {
            return localStorage.getItem('admin_logged_in') === 'true';
        }

        // 登出函数
        function logout() {
            // 停止token过期检查
            stopTokenExpiryCheck();
            
            // 清除localStorage中的认证信息
            localStorage.removeItem('admin_logged_in');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('token_expiry');
            
            // 移除可能存在的过期提示弹窗
            const expiredModal = document.getElementById('token-expired-modal');
            if (expiredModal) {
                expiredModal.remove();
            }
            
            renderLoginPage();
        }

        // JWT Token解析和验证函数
        function parseJWT(token) {
            try {
                // JWT token由三部分组成，用点号分隔
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // 解析payload部分（第二部分）
                const payload = parts[1];
                // Base64 URL解码
                const base64Url = payload.replace(/-/g, '+').replace(/_/g, '/');
                const base64 = base64Url.replace(/[^A-Za-z0-9+/]/g, '');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('JWT解析错误:', error);
                return null;
            }
        }

        // 检查token是否过期
        function isTokenExpired(token) {
            if (!token) {
                return true;
            }
            
            const decoded = parseJWT(token);
            if (!decoded || !decoded.exp) {
                return true;
            }
            
            // exp是Unix时间戳（秒），转换为毫秒
            const expiryTime = decoded.exp * 1000;
            const currentTime = Date.now();
            
            // 提前5分钟判断为过期，给刷新留出时间
            const bufferTime = 5 * 60 * 1000;
            
            return currentTime >= (expiryTime - bufferTime);
        }

        // 获取token剩余有效期（分钟）
        function getTokenExpiryMinutes(token) {
            if (!token) {
                return 0;
            }
            
            const decoded = parseJWT(token);
            if (!decoded || !decoded.exp) {
                return 0;
            }
            
            const expiryTime = decoded.exp * 1000;
            const currentTime = Date.now();
            const remainingTime = expiryTime - currentTime;
            
            return Math.max(0, Math.floor(remainingTime / (60 * 1000)));
        }

        // 增强的登录状态检查，包含token过期检测
        function isLoggedIn() {
            const loggedIn = localStorage.getItem('admin_logged_in') === 'true';
            const token = localStorage.getItem('admin_token');
            
            if (!loggedIn || !token) {
                return false;
            }
            
            // 检查token是否过期
            if (isTokenExpired(token)) {
                console.log('Token已过期，自动登出');
                logout();
                return false;
            }
            
            return true;
        }

        // 显示token过期提醒
        function showTokenExpiryWarning() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                return;
            }
            
            const remainingMinutes = getTokenExpiryMinutes(token);
            
            // 如果剩余时间少于30分钟，显示提醒
            if (remainingMinutes > 0 && remainingMinutes <= 30) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'token-expiry-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 12px 20px;
                    border-radius: 6px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    z-index: 9999;
                    font-size: 14px;
                    max-width: 300px;
                `;
                
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span>⚠️ 登录即将在 ${remainingMinutes} 分钟后过期</span>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 16px; cursor: pointer; margin-left: 10px;">×</button>
                    </div>
                `;
                
                // 避免重复添加
                if (!document.getElementById('token-expiry-warning')) {
                    document.body.appendChild(warningDiv);
                    
                    // 5分钟后自动移除提醒
                    setTimeout(() => {
                        const warning = document.getElementById('token-expiry-warning');
                        if (warning) {
                            warning.remove();
                        }
                    }, 5 * 60 * 1000);
                }
            }
        }

        // 处理401未授权响应（token过期或无效）
        function handleUnauthorizedResponse() {
            console.log('收到401未授权响应，token可能已过期');
            
            // 显示友好的过期提示
            const expiryDiv = document.createElement('div');
            expiryDiv.id = 'token-expired-modal';
            expiryDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            expiryDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; text-align: center; max-width: 400px;">
                    <h3 style="color: #dc3545; margin-top: 0;">🔒 登录已过期</h3>
                    <p style="margin: 15px 0; color: #666;">您的登录已过期，请重新登录以继续使用管理后台。</p>
                    <button onclick="logout(); this.closest('#token-expired-modal').remove();" 
                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        重新登录
                    </button>
                </div>
            `;
            
            document.body.appendChild(expiryDiv);
        }

        // 全局fetcher配置，添加认证头和401处理
        const fetcher = (config) => {
            console.log('Fetcher被调用，配置:', config);
            
            // 在发送请求前检查token是否过期
            const token = localStorage.getItem('admin_token');
            if (token && isTokenExpired(token)) {
                console.log('Token已过期，阻止API请求');
                handleUnauthorizedResponse();
                return Promise.reject(new Error('Token expired'));
            }
            
            console.log('从localStorage获取的令牌:', token);
            if (token) {
                config.headers = config.headers || {};
                config.headers['Authorization'] = `Bearer ${token}`;
                console.log('添加了认证头:', config.headers['Authorization']);
            } else {
                console.log('未找到认证令牌');
            }
            console.log('最终发送的配置:', config);
            
            // 使用axios发送请求
            return amisRequire('axios')(config)
                .then(response => {
                    console.log('API响应:', response);
                    return response;
                })
                .catch(error => {
                    console.error('API错误:', error);
                    
                    // 检查是否是401未授权错误
                    if (error.response && error.response.status === 401) {
                        console.log('收到401响应，处理token过期');
                        handleUnauthorizedResponse();
                    }
                    
                    throw error;
                });
        };
        
        // 渲染登录页面
        function renderLoginPage() {
            const loginPageConfig = {
                type: 'page',
                title: 'AI资讯平台管理后台 - 登录',
                body: {
                    type: 'form',
                    api: {
                        url: '/api/auth/admin-login',
                        method: 'post',
                        adaptor: function (payload, response) {
                            console.log('登录请求发送的数据:', payload);
                            console.log('后端返回的响应:', response);
                            // 获取实际的响应数据
                            const responseData = response.data || response;
                            console.log('实际响应数据:', responseData);
                            // 检查登录是否成功
                            if (responseData.message === "管理员登录成功") {
                                console.log('登录成功');
                                // 登录成功，保存令牌
                                localStorage.setItem('admin_logged_in', 'true');
                                localStorage.setItem('admin_token', responseData.token);
                                
                                // 解析token并存储过期时间
                                const decodedToken = parseJWT(responseData.token);
                                if (decodedToken && decodedToken.exp) {
                                    const expiryTime = decodedToken.exp * 1000; // 转换为毫秒
                                    localStorage.setItem('token_expiry', expiryTime.toString());
                                    console.log('Token过期时间:', new Date(expiryTime).toLocaleString());
                                }
                                
                                // 启动token过期检查定时器
                                startTokenExpiryCheck();
                                
                                // 重新渲染主页面
                                setTimeout(() => {
                                    renderMainPage();
                                }, 100);
                                return {
                                    status: 0,
                                    msg: '登录成功',
                                    data: {
                                        token: responseData.token
                                    }
                                };
                            } else {
                                console.log('登录失败');
                                return {
                                    status: 1,
                                    msg: responseData.message || '用户名或密码错误'
                                };
                            }
                        }
                    },
                    redirect: '',
                    body: [
                        {
                            type: 'input-text',
                            name: 'username',
                            label: '用户名',
                            required: true,
                            placeholder: '请输入用户名'
                        },
                        {
                            type: 'input-password',
                            name: 'password',
                            label: '密码',
                            required: true,
                            placeholder: '请输入密码'
                        }
                    ],
                    actions: [
                        {
                            type: 'submit',
                            label: '登录',
                            level: 'primary'
                        }
                    ]
                }
            };

            const amis = amisRequire('amis/embed');
            amis.embed('#root', loginPageConfig, {}, fetcher);
        }

        // 渲染主页面 - 使用条件渲染但避免重复请求
        function renderMainPage() {
            // 检查是否有有效的认证令牌
            const token = localStorage.getItem('admin_token');
            console.log('渲染主页面时检查令牌:', token);
            if (!token) {
                console.log('未找到令牌，重定向到登录页面');
                renderLoginPage();
                return;
            }
            console.log('找到令牌，渲染主页面');
            
            // 获取当前Hash路径
            const hashPath = window.location.hash.substring(1) || '/home';
            console.log('当前Hash路径:', hashPath);
            
            // 构建主页面配置 - 使用条件渲染避免重复初始化
            const mainPageConfig = {
                type: 'page',
                title: 'AI资讯平台管理后台',
                toolbar: {
                    type: 'tpl',
                    tpl: '<div class="pull-right"><button class="btn btn-link" onclick="logout()">登出</button></div>'
                },
                body: {
                    type: 'grid',
                    columns: [
                        {
                            md: 3,
                            body: {
                                type: 'wrapper',
                                className: 'bg-light padder-v',
                                body: {
                                    type: 'nav',
                                    stacked: true,
                                    className: 'nav-pills nav-stacked',
                                    links: [
                                        {
                                            label: '首页',
                                            icon: 'fa fa-home',
                                            to: '#/home',
                                            active: hashPath === '/home'
                                        },
                                        {
                                            label: '用户管理',
                                            icon: 'fa fa-users',
                                            to: '#/users',
                                            active: hashPath === '/users'
                                        },
                                        {
                                            label: 'RSS源管理',
                                            icon: 'fa fa-rss',
                                            to: '#/sources',
                                            active: hashPath === '/sources'
                                        },
                                        {
                                            label: '内容管理',
                                            icon: 'fa fa-newspaper-o',
                                            to: '#/contents',
                                            active: hashPath === '/contents'
                                        },
                                        {
                                            label: '系统监控',
                                            icon: 'fa fa-dashboard',
                                            to: '#/system',
                                            active: hashPath === '/system'
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            md: 9,
                            body: [
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/home"`,
                                    body: getHomePageConfig().body
                                },
                                {
                                    type: 'wrapper', 
                                    visibleOn: `window.location.hash === "#/users"`,
                                    body: getUsersPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/sources"`, 
                                    body: getSourcesPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/contents"`,
                                    body: getContentsPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/system"`,
                                    body: getSystemPageConfig().body
                                }
                            ]
                        }
                    ]
                }
            };

            console.log('主页面配置:', mainPageConfig);
            console.log('开始渲染amis页面...');
            
            // 清理之前的实例，避免内存泄漏
            const rootElement = document.getElementById('root');
            if (window.amisInstance) {
                try {
                    console.log('销毁旧amis实例');
                    window.amisInstance.destroy();
                } catch (e) {
                    console.log('销毁旧实例时出错:', e);
                }
            }
            
            // 清空DOM
            rootElement.innerHTML = '';
            
            // 渲染新实例
            const amis = amisRequire('amis/embed');
            window.amisInstance = amis.embed('#root', mainPageConfig, {}, fetcher);
            
            console.log('amis页面渲染完成:', window.amisInstance);
            
            // 只有初次加载才设置默认Hash，避免循环
            if (!window.location.hash || window.location.hash === '#') {
                window.location.hash = '#/home';
            }
        }
        
        // 首页配置
        function getHomePageConfig() {
            return {
                type: 'page',
                title: '首页',
                body: [
                    {
                        type: 'tpl',
                        tpl: '<h3>欢迎使用AI资讯平台管理后台</h3><p>请选择左侧菜单进行操作</p>',
                        inline: false
                    }
                ]
            };
        }
        
        // 用户管理页面配置
        function getUsersPageConfig() {
            return {
                type: 'page',
                title: '用户管理',
                body: {
                    type: 'service',
                    api: {
                        method: 'get',
                        url: '/admin/users/statistics',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    },
                    body: [
                        {
                            type: 'grid',
                            columns: [
                                {
                                    type: 'panel',
                                    title: '用户总数',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${totalUsers}</h2><p>用户</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: '活跃用户',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${activeUsers}</h2><p>活跃</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: '待审核用户',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${pendingUsers}</h2><p>待审核</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: '近期注册',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${recentRegistrations}</h2><p>7天内</p>'
                                    }
                                }
                            ]
                        },
                        {
                            type: 'crud',
                            api: {
                                method: 'get',
                                url: '/admin/users',
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                }
                            },
                            defaultParams: {
                                limit: 20
                            },
                            pageField: 'page',
                            perPageField: 'limit',
                            loadDataOnce: false,
                            interval: 0,
                            silentPolling: false,
                            stopAutoRefreshWhen: 'true',
                            syncLocation: true,
                            columns: [
                                {
                                    name: 'id',
                                    label: 'ID',
                                    type: 'text',
                                    width: 60
                                },
                                {
                                    name: 'email',
                                    label: '邮箱',
                                    type: 'text',
                                    width: 200
                                },
                                {
                                    name: 'status',
                                    label: '状态',
                                    type: 'mapping',
                                    map: {
                                        'active': '<span class="label label-success">活跃</span>',
                                        'inactive': '<span class="label label-default">非活跃</span>',
                                        'suspended': '<span class="label label-danger">已停用</span>',
                                        'pending': '<span class="label label-warning">待审核</span>'
                                    },
                                    width: 80
                                },
                                {
                                    name: 'role',
                                    label: '角色',
                                    type: 'mapping',
                                    map: {
                                        'user': '<span class="label label-default">用户</span>',
                                        'admin': '<span class="label label-info">管理员</span>',
                                        'super_admin': '<span class="label label-warning">超级管理员</span>'
                                    },
                                    width: 80
                                },
                                {
                                    name: 'isVerified',
                                    label: '已验证',
                                    type: 'mapping',
                                    map: {
                                        '1': '<span class="label label-success">是</span>',
                                        '0': '<span class="label label-default">否</span>'
                                    },
                                    width: 80
                                },
                                {
                                    name: 'loginCount',
                                    label: '登录次数',
                                    type: 'text',
                                    width: 80
                                },
                                {
                                    name: 'lastLoginAt',
                                    label: '最后登录',
                                    type: 'datetime',
                                    width: 150
                                },
                                {
                                    name: 'createdAt',
                                    label: '注册时间',
                                    type: 'datetime',
                                    width: 150
                                },
                                {
                                    type: 'operation',
                                    label: '操作',
                                    width: 200,
                                    buttons: [
                                        {
                                            type: 'button',
                                            label: '详情',
                                            level: 'info',
                                            size: 'xs',
                                            icon: 'fa fa-eye',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: '用户详情 - ${email}',
                                                size: 'lg',
                                                body: {
                                                    type: 'service',
                                                    api: {
                                                        method: 'get',
                                                        url: '/admin/users/${id}',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: {
                                                        type: 'tabs',
                                                        tabs: [
                                                            {
                                                                title: '基本信息',
                                                                body: {
                                                                    type: 'form',
                                                                    mode: 'normal',
                                                                    body: [
                                                                        {
                                                                            type: 'static',
                                                                            name: 'id',
                                                                            label: 'ID'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'email',
                                                                            label: '邮箱'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'status',
                                                                            label: '状态',
                                                                            tpl: '${status === "active" ? "活跃" : status === "inactive" ? "非活跃" : status === "suspended" ? "已停用" : "待审核"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'role',
                                                                            label: '角色',
                                                                            tpl: '${role === "user" ? "用户" : role === "admin" ? "管理员" : "超级管理员"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'isVerified',
                                                                            label: '已验证',
                                                                            tpl: '${isVerified ? "是" : "否"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'loginCount',
                                                                            label: '登录次数'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'lastLoginAt',
                                                                            label: '最后登录',
                                                                            format: 'YYYY-MM-DD HH:mm:ss'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'lastLoginIp',
                                                                            label: '最后登录IP'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'registeredIp',
                                                                            label: '注册IP'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'riskLevel',
                                                                            label: '风险等级',
                                                                            tpl: '${riskLevel === "low" ? "低" : riskLevel === "medium" ? "中" : "高"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'createdAt',
                                                                            label: '注册时间',
                                                                            format: 'YYYY-MM-DD HH:mm:ss'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'notes',
                                                                            label: '备注'
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                title: '角色权限',
                                                                body: {
                                                                    type: 'service',
                                                                    api: {
                                                                        method: 'get',
                                                                        url: '/admin/roles/users/${id}/roles',
                                                                        headers: {
                                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                        }
                                                                    },
                                                                    body: {
                                                                        type: 'crud',
                                                                        columns: [
                                                                            {
                                                                                name: 'name',
                                                                                label: '角色名称'
                                                                            },
                                                                            {
                                                                                name: 'description',
                                                                                label: '角色描述'
                                                                            },
                                                                            {
                                                                                name: 'permissions',
                                                                                label: '权限',
                                                                                type: 'tpl',
                                                                                tpl: '${permissions}'
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            },
                                                            {
                                                                title: '操作日志',
                                                                body: {
                                                                    type: 'service',
                                                                    api: {
                                                                        method: 'get',
                                                                        url: '/admin/users/${id}/logs',
                                                                        headers: {
                                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                        }
                                                                    },
                                                                    body: {
                                                                        type: 'crud',
                                                                        columns: [
                                                                            {
                                                                                name: 'operation',
                                                                                label: '操作类型',
                                                                                type: 'mapping',
                                                                                map: {
                                                                                    'create': '创建',
                                                                                    'update': '更新',
                                                                                    'delete': '删除',
                                                                                    'status_change': '状态变更',
                                                                                    'role_change': '角色变更',
                                                                                    'login': '登录',
                                                                                    'logout': '登出'
                                                                                }
                                                                            },
                                                                            {
                                                                                name: 'result',
                                                                                label: '结果',
                                                                                type: 'mapping',
                                                                                map: {
                                                                                    'success': '<span class="label label-success">成功</span>',
                                                                                    'failure': '<span class="label label-danger">失败</span>'
                                                                                }
                                                                            },
                                                                            {
                                                                                name: 'ipAddress',
                                                                                label: 'IP地址'
                                                                            },
                                                                            {
                                                                                name: 'timestamp',
                                                                                label: '时间',
                                                                                type: 'datetime',
                                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            type: 'button',
                                            label: '状态',
                                            level: 'warning',
                                            size: 'xs',
                                            icon: 'fa fa-toggle-on',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: '更改用户状态 - ${email}',
                                                body: {
                                                    type: 'form',
                                                    api: {
                                                        method: 'put',
                                                        url: '/admin/users/${id}/status',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: [
                                                        {
                                                            type: 'select',
                                                            name: 'status',
                                                            label: '新状态',
                                                            required: true,
                                                            options: [
                                                                { label: '活跃', value: 'active' },
                                                                { label: '非活跃', value: 'inactive' },
                                                                { label: '已停用', value: 'suspended' },
                                                                { label: '待审核', value: 'pending' }
                                                            ]
                                                        },
                                                        {
                                                            type: 'textarea',
                                                            name: 'reason',
                                                            label: '变更原因'
                                                        }
                                                    ]
                                                }
                                            }
                                        },
                                        {
                                            type: 'button',
                                            label: '角色',
                                            level: 'primary',
                                            size: 'xs',
                                            icon: 'fa fa-user-tag',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: '分配角色 - ${email}',
                                                body: {
                                                    type: 'service',
                                                    api: {
                                                        method: 'get',
                                                        url: '/admin/roles',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: {
                                                        type: 'form',
                                                        api: {
                                                            method: 'put',
                                                            url: '/admin/users/${id}/role',
                                                            headers: {
                                                                'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                            }
                                                        },
                                                        body: [
                                                            {
                                                                type: 'select',
                                                                name: 'roleId',
                                                                label: '选择角色',
                                                                required: true,
                                                                source: {
                                                                    method: 'get',
                                                                    url: '/admin/roles',
                                                                    headers: {
                                                                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                    },
                                                                    adaptor: function(payload, response) {
                                                                        const data = response.data || response;
                                                                        return {
                                                                            options: data.roles.map(role => ({
                                                                                label: role.name,
                                                                                value: role.id
                                                                            }))
                                                                        };
                                                                    }
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            type: 'button',
                                            label: '会话',
                                            level: 'info',
                                            size: 'xs',
                                            icon: 'fa fa-laptop',
                                            actionType: 'dialog',
                                            dialog: {
                                                title: '用户会话 - ${email}',
                                                body: {
                                                    type: 'service',
                                                    api: {
                                                        method: 'get',
                                                        url: '/admin/users/${id}/sessions',
                                                        headers: {
                                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                        }
                                                    },
                                                    body: {
                                                        type: 'crud',
                                                        columns: [
                                                            {
                                                                name: 'ipAddress',
                                                                label: 'IP地址'
                                                            },
                                                            {
                                                                name: 'userAgent',
                                                                label: '用户代理'
                                                            },
                                                            {
                                                                name: 'lastActivityAt',
                                                                label: '最后活动',
                                                                type: 'datetime',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            },
                                                            {
                                                                name: 'expiresAt',
                                                                label: '过期时间',
                                                                type: 'datetime',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            },
                                                            {
                                                                type: 'operation',
                                                                label: '操作',
                                                                width: 80,
                                                                buttons: [
                                                                    {
                                                                        type: 'button',
                                                                        label: '下线',
                                                                        level: 'danger',
                                                                        size: 'xs',
                                                                        actionType: 'ajax',
                                                                        confirmText: '确认强制该用户下线？',
                                                                        api: {
                                                                            method: 'delete',
                                                                            url: '/admin/users/${id}/sessions/${sessionId}',
                                                                            headers: {
                                                                                'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                                            }
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            ],
                            headerToolbar: [
                                {
                                    type: 'form',
                                    title: '搜索筛选',
                                    target: 'crud',
                                    mode: 'inline',
                                    body: [
                                        {
                                            type: 'input-text',
                                            name: 'search',
                                            placeholder: '搜索邮箱...',
                                            clearable: true
                                        },
                                        {
                                            type: 'select',
                                            name: 'status',
                                            placeholder: '状态',
                                            options: [
                                                { label: '全部', value: '' },
                                                { label: '活跃', value: 'active' },
                                                { label: '非活跃', value: 'inactive' },
                                                { label: '已停用', value: 'suspended' },
                                                { label: '待审核', value: 'pending' }
                                            ],
                                            clearable: true
                                        },
                                        {
                                            type: 'select',
                                            name: 'role',
                                            placeholder: '角色',
                                            options: [
                                                { label: '全部', value: '' },
                                                { label: '用户', value: 'user' },
                                                { label: '管理员', value: 'admin' },
                                                { label: '超级管理员', value: 'super_admin' }
                                            ],
                                            clearable: true
                                        },
                                        {
                                            type: 'submit',
                                            label: '搜索',
                                            level: 'primary'
                                        }
                                    ]
                                },
                                {
                                    type: 'button',
                                    label: '批量操作',
                                    level: 'danger',
                                    icon: 'fa fa-tasks',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: '批量操作',
                                        body: {
                                            type: 'form',
                                            api: {
                                                method: 'post',
                                                url: '/admin/users/batch',
                                                headers: {
                                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                }
                                            },
                                            body: [
                                                {
                                                    type: 'select',
                                                    name: 'operation',
                                                    label: '操作类型',
                                                    required: true,
                                                    options: [
                                                        { label: '激活用户', value: 'activate' },
                                                        { label: '停用用户', value: 'deactivate' },
                                                        { label: '暂停用户', value: 'suspend' }
                                                    ]
                                                },
                                                {
                                                    type: 'hidden',
                                                    name: 'userIds',
                                                    value: '${selectedItems|map:item=>item.id|join:,}'
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'pagination',
                                    align: 'right'
                                }
                            ],
                            footerToolbar: [
                                'statistics',
                                {
                                    type: 'pagination',
                                    align: 'right'
                                }
                            ]
                        }
                    ]
                }
            };
        }
        
        // RSS源管理页面配置
        function getSourcesPageConfig() {
            return {
                type: 'page',
                title: 'RSS源管理',
                body: {
                    type: 'crud',
                    api: {
                        method: 'get',
                        url: '/admin/sources',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    },
                    defaultParams: {
                        perPage: 10
                    },
                    pageField: 'page',
                    perPageField: 'perPage',
                    loadDataOnce: false, // 启用分页
                    interval: 0, // 禁用轮询
                    silentPolling: false, // 禁用静默轮询
                    stopAutoRefreshWhen: 'true', // 始终停止自动刷新
                    syncLocation: true, // 启用URL同步以支持分页
                    columns: [
                        {
                            name: 'id',
                            label: 'ID',
                            type: 'text',
                            width: 60
                        },
                        {
                            name: 'name',
                            label: '源名称',
                            type: 'text',
                            searchable: true
                        },
                        {
                            name: 'url',
                            label: 'URL',
                            type: 'text',
                            searchable: true
                        },
                        {
                            name: 'description',
                            label: '描述',
                            type: 'text'
                        },
                        {
                            name: 'userId',
                            label: '所属用户',
                            type: 'text'
                        },
                        {
                            name: 'isPublic',
                            label: '公开',
                            type: 'mapping',
                            map: {
                                'true': '<span class="label label-success">公开</span>',
                                'false': '<span class="label label-default">私有</span>'
                            }
                        },
                        {
                            name: 'isRecommended',
                            label: '推荐',
                            type: 'mapping',
                            map: {
                                'true': '<span class="label label-info">推荐</span>',
                                'false': '<span class="label label-default">普通</span>'
                            }
                        },
                        {
                            name: 'recommendationLevel',
                            label: '推荐级别',
                            type: 'mapping',
                            map: {
                                'basic': '<span class="label label-default">基础</span>',
                                'premium': '<span class="label label-warning">高级</span>',
                                'featured': '<span class="label label-purple">精选</span>'
                            }
                        },
                        {
                            name: 'qualityValidationStatus',
                            label: '验证状态',
                            type: 'mapping',
                            map: {
                                'pending': '<span class="label label-warning">待验证</span>',
                                'approved': '<span class="label label-success">已通过</span>',
                                'rejected': '<span class="label label-danger">已拒绝</span>'
                            }
                        },
                        {
                            name: 'qualityAvailability',
                            label: '可用性',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'qualityContentQuality',
                            label: '内容质量',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'fetchFailureCount',
                            label: '失败次数',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'lastFetchedAt',
                            label: '上次获取',
                            type: 'datetime',
                            format: 'YYYY-MM-DD HH:mm:ss'
                        },
                        {
                            name: 'statisticsTotalSubscribers',
                            label: '总订阅',
                            type: 'text',
                            width: 80
                        },
                        {
                            name: 'createdAt',
                            label: '创建时间',
                            type: 'datetime',
                            format: 'YYYY-MM-DD HH:mm:ss'
                        },
                        {
                            type: 'operation',
                            label: '操作',
                            width: 260,
                            buttons: [
                                {
                                    label: '查看详情',
                                    type: 'button',
                                    level: 'primary',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'RSS源详情',
                                        body: {
                                            type: 'form',
                                            static: true,
                                            body: [
                                                {
                                                    type: 'static',
                                                    name: 'id',
                                                    label: 'ID'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'name',
                                                    label: '名称'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'url',
                                                    label: 'URL'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'description',
                                                    label: '描述'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'userId',
                                                    label: '所属用户ID'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'isPublic',
                                                    label: '是否公开'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'isRecommended',
                                                    label: '是否推荐'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'recommendationLevel',
                                                    label: '推荐级别'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityAvailability',
                                                    label: '可用性评分'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityContentQuality',
                                                    label: '内容质量评分'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityUpdateFrequency',
                                                    label: '更新频率评分'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'qualityValidationStatus',
                                                    label: '验证状态'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'fetchFailureCount',
                                                    label: '获取失败次数'
                                                },
                                                {
                                                    type: 'static',
                                                    name: 'statisticsTotalSubscribers',
                                                    label: '总订阅数'
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    label: '手动获取',
                                    type: 'button',
                                    level: 'info',
                                    actionType: 'ajax',
                                    api: {
                                        method: 'post',
                                        url: '/api/sources/${id}/trigger-fetch',
                                        headers: {
                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                        }
                                    },
                                    confirmText: '确定要手动触发此RSS源的获取吗？'
                                },
                                {
                                    type: 'button',
                                    label: '内容',
                                    level: 'info',
                                    size: 'xs',
                                    icon: 'fa fa-list',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: 'RSS内容列表 - ${name}',
                                        size: 'xl',
                                        body: {
                                            type: 'crud',
                                            api: {
                                                method: 'get',
                                                url: '/api/sources/${id}/entries',
                                                headers: {
                                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                }
                                            },
                                            defaultParams: {
                                                perPage: 10
                                            },
                                            pageField: 'page',
                                            perPageField: 'perPage',
                                            interval: 0, // 禁用轮询
                                            silentPolling: false,
                                            stopAutoRefreshWhen: 'true',
                                            syncLocation: true, // 启用URL同步以支持分页
                                            columns: [
                                                {
                                                    name: 'id',
                                                    label: 'ID',
                                                    type: 'text',
                                                    width: 60
                                                },
                                                {
                                                    name: 'title',
                                                    label: '标题',
                                                    type: 'text'
                                                },
                                                {
                                                    name: 'publishedAt',
                                                    label: '发布时间',
                                                    type: 'datetime',
                                                    width: 150
                                                },
                                                {
                                                    name: 'processed',
                                                    label: '处理状态',
                                                    type: 'mapping',
                                                    map: {
                                                        '1': '<span class="label label-success">已处理</span>',
                                                        '0': '<span class="label label-warning">未处理</span>'
                                                    },
                                                    width: 100
                                                },
                                                {
                                                    name: 'failureCount',
                                                    label: '失败次数',
                                                    type: 'text',
                                                    width: 80
                                                },
                                                {
                                                    type: 'operation',
                                                    label: '操作',
                                                    width: 80,
                                                    buttons: [
                                                        {
                                                            type: 'button',
                                                            label: '详情',
                                                            level: 'link',
                                                            size: 'xs',
                                                            actionType: 'dialog',
                                                            dialog: {
                                                                title: '内容详情 - ${title}',
                                                                size: 'lg',
                                                                body: {
                                                                    type: 'form',
                                                                    mode: 'normal',
                                                                    body: [
                                                                        {
                                                                            type: 'static',
                                                                            name: 'title',
                                                                            label: '标题'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'link',
                                                                            label: '链接'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'publishedAt',
                                                                            label: '发布时间',
                                                                            format: 'YYYY-MM-DD HH:mm:ss'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'processed',
                                                                            label: '处理状态',
                                                                            tpl: '${processed ? "已处理" : "未处理"}'
                                                                        },
                                                                        {
                                                                            type: 'static',
                                                                            name: 'content',
                                                                            label: '内容',
                                                                            tpl: '<div style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${content}</div>'
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'button',
                                    label: '编辑',
                                    level: 'warning',
                                    size: 'xs',
                                    icon: 'fa fa-edit',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: '编辑RSS源',
                                        body: {
                                            type: 'form',
                                            api: {
                                                method: 'put',
                                                url: '/api/sources/${id}',
                                                headers: {
                                                    'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                                }
                                            },
                                            body: [
                                                {
                                                    type: 'input-text',
                                                    name: 'name',
                                                    label: '名称',
                                                    required: true
                                                },
                                                {
                                                    type: 'input-text',
                                                    name: 'url',
                                                    label: 'URL',
                                                    required: true
                                                },
                                                {
                                                    type: 'input-text',
                                                    name: 'description',
                                                    label: '描述'
                                                },
                                                {
                                                    type: 'switch',
                                                    name: 'isPublic',
                                                    label: '是否公开',
                                                    trueValue: true,
                                                    falseValue: false
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'button',
                                    label: '删除',
                                    level: 'danger',
                                    size: 'xs',
                                    icon: 'fa fa-trash',
                                    actionType: 'ajax',
                                    confirmText: '您确认要删除该RSS源?',
                                    api: {
                                        method: 'delete',
                                        url: '/api/sources/${id}',
                                        headers: {
                                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                                        }
                                    },
                                    feedback: {
                                        title: '删除成功',
                                        body: 'RSS源已成功删除'
                                    }
                                }
                            ]
                        }
                    ],
                    filter: {
                        title: '搜索筛选',
                        submitText: '搜索',
                        controls: [
                            {
                                type: 'text',
                                name: 'search',
                                label: '搜索',
                                placeholder: '搜索名称、URL或描述'
                            },
                            {
                                type: 'select',
                                name: 'isRecommended',
                                label: '推荐状态',
                                options: [
                                    { label: '全部', value: '' },
                                    { label: '推荐源', value: 'true' },
                                    { label: '普通源', value: 'false' }
                                ]
                            },
                            {
                                type: 'select',
                                name: 'qualityValidationStatus',
                                label: '验证状态',
                                options: [
                                    { label: '全部', value: '' },
                                    { label: '待验证', value: 'pending' },
                                    { label: '已通过', value: 'approved' },
                                    { label: '已拒绝', value: 'rejected' }
                                ]
                            },
                            {
                                type: 'text',
                                name: 'userId',
                                label: '用户ID',
                                placeholder: '输入用户ID'
                            }
                        ]
                    },
                    features: ['filter', 'create', 'update', 'delete'],
                    headerToolbar: [
                        {
                            type: 'reload',
                            label: '刷新',
                            icon: 'fa fa-refresh'
                        },
                        {
                            type: 'columns-toggler',
                            label: '列显示',
                            icon: 'fa fa-columns'
                        }
                    ],
                    footerToolbar: [
                        'statistics',
                        {
                            type: 'pagination',
                            align: 'right'
                        }
                    ]
                }
            };
        }
        
        // 系统监控页面配置
        function getSystemPageConfig() {
            return {
                type: 'page',
                title: '系统监控',
                body: {
                    type: 'service',
                    api: {
                        method: 'get',
                        url: '/system/stats',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        },
                        cache: 0 // 禁用缓存
                    },
                    interval: 0, // 禁用轮询
                    body: [
                        {
                            type: 'grid',
                            columns: [
                                {
                                    type: 'panel',
                                    title: '用户总数',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${userCount}</h2><p>用户</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: 'RSS源总数',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${sourceCount}</h2><p>RSS源</p>'
                                    }
                                },
                                {
                                    type: 'panel',
                                    title: '失败源数量',
                                    body: {
                                        type: 'tpl',
                                        tpl: '<h2>${failedSourceCount}</h2><p>失败源</p>'
                                    }
                                }
                            ]
                        }
                    ]
                }
            };
        }
        
        // 内容管理页面配置
        function getContentsPageConfig() {
            return {
                type: 'page',
                title: '内容管理',
                body: {
                    type: 'crud',
                    api: {
                        method: 'get',
                        url: '/sources/entries/all',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    },
                    defaultParams: {
                        perPage: 20
                    },
                    pageField: 'page',
                    perPageField: 'perPage',
                    interval: 0, // 禁用轮询
                    silentPolling: false,
                    stopAutoRefreshWhen: 'true',
                    syncLocation: true, // 启用URL同步以支持分页
                    columns: [
                        {
                            name: 'id',
                            label: 'ID',
                            type: 'text',
                            width: 60
                        },
                        {
                            name: 'sourceName',
                            label: 'RSS源',
                            type: 'text',
                            width: 120
                        },
                        {
                            name: 'title',
                            label: '标题',
                            type: 'text'
                        },
                        {
                            name: 'content',
                            label: '内容预览',
                            type: 'text',
                            width: 200
                        },
                        {
                            name: 'publishedAt',
                            label: '发布时间',
                            type: 'datetime',
                            width: 150
                        },
                        {
                            name: 'processed',
                            label: '处理状态',
                            type: 'mapping',
                            map: {
                                '1': '<span class="label label-success">已处理</span>',
                                '0': '<span class="label label-warning">未处理</span>'
                            },
                            width: 100
                        },
                        {
                            name: 'failureCount',
                            label: '失败次数',
                            type: 'text',
                            width: 80
                        },
                        {
                            type: 'operation',
                            label: '操作',
                            width: 120,
                            buttons: [
                                {
                                    type: 'button',
                                    label: '详情',
                                    level: 'info',
                                    size: 'xs',
                                    icon: 'fa fa-eye',
                                    actionType: 'dialog',
                                    dialog: {
                                        title: '内容详情 - ${title}',
                                        size: 'xl',
                                        body: {
                                            type: 'tabs',
                                            tabs: [
                                                {
                                                    title: '基本信息',
                                                    body: {
                                                        type: 'form',
                                                        mode: 'normal',
                                                        body: [
                                                            {
                                                                type: 'static',
                                                                name: 'id',
                                                                label: 'ID'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'sourceName',
                                                                label: 'RSS源'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'title',
                                                                label: '标题'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'link',
                                                                label: '链接',
                                                                tpl: '<a href="${link}" target="_blank">${link}</a>'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'publishedAt',
                                                                label: '发布时间',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'processed',
                                                                label: '处理状态',
                                                                tpl: '${processed ? "已处理" : "未处理"}'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'failureCount',
                                                                label: '失败次数'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'errorMessage',
                                                                label: '错误信息',
                                                                visibleOn: '${errorMessage}',
                                                                tpl: '<span class="text-danger">${errorMessage}</span>'
                                                            },
                                                            {
                                                                type: 'static',
                                                                name: 'createdAt',
                                                                label: '抓取时间',
                                                                format: 'YYYY-MM-DD HH:mm:ss'
                                                            }
                                                        ]
                                                    }
                                                },
                                                {
                                                    title: '原始内容',
                                                    body: {
                                                        type: 'form',
                                                        mode: 'normal',
                                                        body: [
                                                            {
                                                                type: 'static',
                                                                name: 'content',
                                                                label: '内容',
                                                                tpl: '<div style="max-height: 500px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9;">${content|raw}</div>'
                                                            }
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    type: 'button',
                                    label: '访问',
                                    level: 'success',
                                    size: 'xs',
                                    icon: 'fa fa-external-link',
                                    actionType: 'url',
                                    url: '${link}',
                                    blank: true
                                }
                            ]
                        }
                    ],
                    headerToolbar: [
                        {
                            type: 'columns-toggler',
                            align: 'left'
                        },
                        {
                            type: 'drag-toggler',
                            align: 'left'
                        },
                        {
                            type: 'pagination',
                            align: 'right'
                        }
                    ],
                    footerToolbar: [
                        'statistics',
                        {
                            type: 'pagination',
                            align: 'right'
                        }
                    ]
                }
            };
        }

        // 全局登出函数
        window.logout = logout;

        // 启动token过期检查定时器
        let tokenCheckInterval;
        function startTokenExpiryCheck() {
            // 清除之前的定时器
            if (tokenCheckInterval) {
                clearInterval(tokenCheckInterval);
            }
            
            // 每分钟检查一次token状态
            tokenCheckInterval = setInterval(() => {
                if (isLoggedIn()) {
                    // 显示过期提醒（如果需要）
                    showTokenExpiryWarning();
                } else {
                    // 如果已经登出，停止检查
                    clearInterval(tokenCheckInterval);
                }
            }, 60 * 1000); // 每分钟检查一次
            
            // 立即执行一次检查
            showTokenExpiryWarning();
        }

        // 停止token过期检查
        function stopTokenExpiryCheck() {
            if (tokenCheckInterval) {
                clearInterval(tokenCheckInterval);
                tokenCheckInterval = null;
            }
            
            // 移除过期提醒
            const warning = document.getElementById('token-expiry-warning');
            if (warning) {
                warning.remove();
            }
        }

        // Hash变化监听器 - 重新渲染页面以触发amis的visibleOn重新计算
        function handleHashChange() {
            console.log('Hash变化检测:', window.location.hash);
            // 需要重新渲染amis实例才能让visibleOn重新计算
            renderMainPage();
        }

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            stopTokenExpiryCheck();
        });

        // 页面加载时检查登录状态并初始化
        if (isLoggedIn()) {
            console.log('用户已登录，初始化主页面');
            renderMainPage();
            
            // 绑定Hash变化监听器
            console.log('绑定Hash变化监听器');
            window.addEventListener('hashchange', handleHashChange);
            
            // 启动token过期检查
            console.log('启动token过期检查');
            startTokenExpiryCheck();
        } else {
            console.log('用户未登录，显示登录页面');
            renderLoginPage();
        }
    </script>
</body>
</html>