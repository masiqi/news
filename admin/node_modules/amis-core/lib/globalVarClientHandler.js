/**
 * amis-core v6.13.0
 * Copyright 2018-2025 fex
 */

'use strict';

var tslib = require('tslib');
var globalVar = require('./globalVar.js');

function loadClientData(key, variables) {
    var str = localStorage.getItem(key);
    var data = {};
    try {
        data = JSON.parse(str || '{}');
    }
    catch (e) {
        console.error("parse localstorage \"".concat(key, " error\""), e);
    }
    var filterData = {};
    variables.forEach(function (item) {
        if (data.hasOwnProperty(item.key)) {
            filterData[item.key] = data[item.key];
        }
    });
    return filterData;
}
function saveClientData(key, values, variables) {
    var str = localStorage.getItem(key);
    var data = {};
    try {
        data = JSON.parse(str || '{}');
    }
    catch (e) {
        console.error("parse localstorage \"".concat(key, " error\""), e);
    }
    Object.assign(data, values);
    localStorage.setItem(key, JSON.stringify(data));
}
function bulkClientGetter(_a) {
    var variables = _a.variables;
    return loadClientData('amis-client-vars', variables);
}
function bulkClientSetter(values, context) {
    return saveClientData('amis-client-vars', values, context.variables);
}
function pageBulkClientGetter(context) {
    var variables = context.variables;
    var key = "amis-client-vars-".concat(context.pageId || location.pathname);
    return loadClientData(key, variables);
}
function pageBulkClientSetter(values, context) {
    var key = "amis-client-vars-".concat(context.pageId || location.pathname);
    return saveClientData(key, values, context.variables);
}
/**
 * 注册全局变量处理器，用来处理 storageOn 为 client 的变量
 *
 * 并且根据变量的 scope 来决定是 page 还是全局的
 *
 * 将数据存入 localStorage
 */
globalVar.registerGlobalVariableHandler(function (variable, context) {
    if (variable.storageOn === 'client') {
        return tslib.__assign(tslib.__assign({}, variable), { bulkGetter: variable.scope === 'page' ? pageBulkClientGetter : bulkClientGetter, bulkSetter: variable.scope === 'page' ? pageBulkClientSetter : bulkClientSetter });
    }
});
