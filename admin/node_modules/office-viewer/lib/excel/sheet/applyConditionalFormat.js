'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var tslib = require('tslib');
var Range = require('../io/excel/util/Range.js');
var aboveAverage = require('./cfRule/aboveAverage.js');
var cellIs = require('./cfRule/cellIs.js');
var colorScale = require('./cfRule/colorScale.js');
var dataBar = require('./cfRule/dataBar.js');
var duplicateValues = require('./cfRule/duplicateValues.js');
var iconSet = require('./cfRule/iconSet.js');
var timePeriod = require('./cfRule/timePeriod.js');
var top10 = require('./cfRule/top10.js');
var uniqueValues = require('./cfRule/uniqueValues.js');
var containsText = require('./cfRule/containsText.js');
var containsBlanks = require('./cfRule/containsBlanks.js');
var containsErrors = require('./cfRule/containsErrors.js');
var notContainsText = require('./cfRule/notContainsText.js');

/**
 * 计算条件格式
 */
function evalRule(sheet, cellInfo, ranges, rule) {
    var type = rule.type;
    switch (type) {
        case 'cellIs':
            return cellIs.cellIs(sheet, cellInfo, rule);
        case 'uniqueValues':
            return uniqueValues.uniqueValues(sheet, cellInfo, ranges, rule);
        case 'duplicateValues':
            return duplicateValues.duplicateValues(sheet, cellInfo, ranges, rule);
        case 'aboveAverage':
            return aboveAverage.aboveAverage(sheet, cellInfo, ranges, rule);
        case 'top10':
            return top10.top10(sheet, cellInfo, ranges, rule);
        case 'colorScale':
            return colorScale.colorScale(sheet, cellInfo, ranges, rule);
        case 'dataBar':
            return dataBar.dataBar(sheet, cellInfo, ranges, rule);
        case 'iconSet':
            return iconSet.iconSet(sheet, cellInfo, ranges, rule);
        case 'timePeriod':
            return timePeriod.timePeriod(sheet, cellInfo, ranges, rule);
        case 'containsText':
            return containsText.containsText(sheet, cellInfo, rule);
        case 'notContainsText':
            return notContainsText.notContainsText(sheet, cellInfo, rule);
        case 'containsBlanks':
            return containsBlanks.containsBlanks(sheet, cellInfo, rule);
        case 'containsErrors':
            return containsErrors.containsErrors(sheet, cellInfo, rule);
        default:
            console.warn('未知的条件格式类型', type);
    }
    return false;
}
function applyConditionalFormat(sheet, cellInfo, row, col) {
    var e_1, _a, e_2, _b, e_3, _c;
    var conditionalFormatting = sheet.getConditionalFormatting();
    try {
        for (var conditionalFormatting_1 = tslib.__values(conditionalFormatting), conditionalFormatting_1_1 = conditionalFormatting_1.next(); !conditionalFormatting_1_1.done; conditionalFormatting_1_1 = conditionalFormatting_1.next()) {
            var formatting = conditionalFormatting_1_1.value;
            var sqref = formatting.sqref;
            if (!sqref) {
                continue;
            }
            var ranges = sqref.split(' ').map(Range.parseRange);
            try {
                for (var ranges_1 = (e_2 = void 0, tslib.__values(ranges)), ranges_1_1 = ranges_1.next(); !ranges_1_1.done; ranges_1_1 = ranges_1.next()) {
                    var range = ranges_1_1.value;
                    if (Range.isCellInRange(range, row, col)) {
                        var cfRules = formatting.cfRule || [];
                        try {
                            for (var cfRules_1 = (e_3 = void 0, tslib.__values(cfRules)), cfRules_1_1 = cfRules_1.next(); !cfRules_1_1.done; cfRules_1_1 = cfRules_1.next()) {
                                var rule = cfRules_1_1.value;
                                try {
                                    var evalResult = evalRule(sheet, cellInfo, ranges, rule);
                                    if (rule.stopIfTrue && evalResult) {
                                        break;
                                    }
                                }
                                catch (error) {
                                    console.warn('条件格式处理失败', error);
                                }
                            }
                        }
                        catch (e_3_1) { e_3 = { error: e_3_1 }; }
                        finally {
                            try {
                                if (cfRules_1_1 && !cfRules_1_1.done && (_c = cfRules_1.return)) _c.call(cfRules_1);
                            }
                            finally { if (e_3) throw e_3.error; }
                        }
                    }
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (ranges_1_1 && !ranges_1_1.done && (_b = ranges_1.return)) _b.call(ranges_1);
                }
                finally { if (e_2) throw e_2.error; }
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (conditionalFormatting_1_1 && !conditionalFormatting_1_1.done && (_a = conditionalFormatting_1.return)) _a.call(conditionalFormatting_1);
        }
        finally { if (e_1) throw e_1.error; }
    }
}

exports.applyConditionalFormat = applyConditionalFormat;
