import { __assign, __values } from 'tslib';
import { rangeRefToString, parseRange } from '../../../io/excel/util/Range.js';

/**
 * 设置列排序，这里实际上应该是命令，但目前只当成一种状态变化，主要是因为现阶段只支持浏览
 */
function setColumnSortOrder(sheet, colIndex, rangeRef, autoFilter, sortOrder, headerRowCount) {
    var e_1, _a;
    var _b;
    var sortStateRangeRef = __assign({}, rangeRef);
    sortStateRangeRef.startCol += colIndex;
    sortStateRangeRef.endCol += colIndex;
    var sortConditionRef = rangeRefToString(sortStateRangeRef);
    var sortCondition = {
        ref: sortConditionRef,
        descending: sortOrder === 'desc'
    };
    if (!autoFilter.sortState) {
        var sortStateRangeRef_1 = __assign({}, rangeRef);
        sortStateRangeRef_1.startRow += headerRowCount;
        var sortStateRef = rangeRefToString(sortStateRangeRef_1);
        autoFilter.sortState = {
            ref: sortStateRef,
            sortCondition: [sortCondition]
        };
        sheet.applyAutoFilter(autoFilter, headerRowCount);
        return;
    }
    if (autoFilter.sortState.sortCondition === undefined) {
        autoFilter.sortState.sortCondition = [];
    }
    try {
        for (var _c = __values(((_b = autoFilter.sortState) === null || _b === void 0 ? void 0 : _b.sortCondition) || []), _d = _c.next(); !_d.done; _d = _c.next()) {
            var condition = _d.value;
            var rangeRef_1 = parseRange(condition.ref || '');
            if (sortStateRangeRef.startCol === rangeRef_1.startCol) {
                // 统一一下 endRow
                rangeRef_1.endRow = sortStateRangeRef.endRow;
                condition.descending = sortOrder === 'desc';
                sheet.applyAutoFilter(autoFilter, headerRowCount);
                return;
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
        }
        finally { if (e_1) throw e_1.error; }
    }
    autoFilter.sortState.sortCondition.push(sortCondition);
    sheet.applyAutoFilter(autoFilter, headerRowCount);
}

export { setColumnSortOrder };
