<!DOCTYPE html>
<html>
<head>
    <title>è°ƒè¯•ç‰ˆæœ¬ - ç®¡ç†åå°</title>
    <script src="https://cdn.jsdelivr.net/npm/amis@6.13.0/sdk/sdk.js"></script>
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
        }
        .debug-log {
            margin: 2px 0;
            padding: 2px 4px;
            border-bottom: 1px solid #e9ecef;
        }
        .debug-log.info { color: #0066cc; }
        .debug-log.success { color: #28a745; }
        .debug-log.error { color: #dc3545; }
        .debug-log.warning { color: #ffc107; }
    </style>
</head>
<body>
    <div id="debug-panel" class="debug-panel">
        <h4>ğŸ” è°ƒè¯•é¢æ¿</h4>
        <div id="debug-logs"></div>
    </div>
    <div id="root"></div>

    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `debug-log ${type}`;
            logDiv.innerHTML = `[${timestamp}] ${message}`;
            
            const logsContainer = document.getElementById('debug-logs');
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        }

        // å…¨å±€å˜é‡
        let amisInstance = null;
        let currentHash = '';
        let clickCount = 0;

        // è·å–token
        function getToken() {
            return localStorage.getItem('admin_token');
        }

        // ç®€åŒ–çš„fetcher
        const fetcher = (api) => {
            debugLog(`APIè¯·æ±‚: ${api.url}`, 'info');
            
            return {
                method: api.method || 'get',
                url: api.url,
                headers: {
                    'Authorization': 'Bearer ' + getToken(),
                    'Content-Type': 'application/json'
                },
                data: api.data,
                withCredentials: false
            };
        };

        // è·å–é¡µé¢é…ç½®å‡½æ•°
        function getHomePageConfig() {
            debugLog('åŠ è½½é¦–é¡µé…ç½®', 'info');
            return {
                type: 'page',
                title: 'é¦–é¡µ',
                body: {
                    type: 'tpl',
                    tpl: '<h2>æ¬¢è¿ä½¿ç”¨AIèµ„è®¯å¹³å°ç®¡ç†åå°</h2><p>å½“å‰Hash: ' + window.location.hash + '</p>'
                }
            };
        }

        function getUsersPageConfig() {
            debugLog('åŠ è½½ç”¨æˆ·ç®¡ç†é¡µé¢é…ç½®', 'info');
            return {
                type: 'page',
                title: 'ç”¨æˆ·ç®¡ç†',
                body: {
                    type: 'crud',
                    api: {
                        method: 'get',
                        url: '/admin/users'
                    },
                    columns: [
                        { name: 'id', label: 'ID' },
                        { name: 'username', label: 'ç”¨æˆ·å' },
                        { name: 'email', label: 'é‚®ç®±' }
                    ]
                }
            };
        }

        function getSourcesPageConfig() {
            debugLog('åŠ è½½RSSæºç®¡ç†é¡µé¢é…ç½®', 'info');
            return {
                type: 'page',
                title: 'RSSæºç®¡ç†',
                body: {
                    type: 'crud',
                    api: {
                        method: 'get',
                        url: '/admin/sources'
                    },
                    columns: [
                        { name: 'id', label: 'ID' },
                        { name: 'name', label: 'åç§°' },
                        { name: 'url', label: 'URL' }
                    ]
                }
            };
        }

        function getContentsPageConfig() {
            debugLog('åŠ è½½å†…å®¹ç®¡ç†é¡µé¢é…ç½®', 'info');
            return {
                type: 'page',
                title: 'å†…å®¹ç®¡ç†',
                body: {
                    type: 'tpl',
                    tpl: '<h2>å†…å®¹ç®¡ç†é¡µé¢</h2><p>å½“å‰Hash: ' + window.location.hash + '</p>'
                }
            };
        }

        function getSystemPageConfig() {
            debugLog('åŠ è½½ç³»ç»Ÿç›‘æ§é¡µé¢é…ç½®', 'info');
            return {
                type: 'page',
                title: 'ç³»ç»Ÿç›‘æ§',
                body: {
                    type: 'tpl',
                    tpl: '<h2>ç³»ç»Ÿç›‘æ§é¡µé¢</h2><p>å½“å‰Hash: ' + window.location.hash + '</p>'
                }
            };
        }

        // æ¸²æŸ“ä¸»é¡µé¢
        function renderMainPage() {
            const token = getToken();
            if (!token) {
                debugLog('æœªæ‰¾åˆ°tokenï¼Œè·³è½¬åˆ°ç™»å½•', 'warning');
                window.location.href = '/';
                return;
            }

            currentHash = window.location.hash.substring(1) || '/home';
            debugLog(`æ¸²æŸ“ä¸»é¡µé¢ï¼Œå½“å‰Hash: ${currentHash}`, 'info');

            const mainPageConfig = {
                type: 'page',
                title: 'AIèµ„è®¯å¹³å°ç®¡ç†åå° (è°ƒè¯•ç‰ˆ)',
                toolbar: {
                    type: 'tpl',
                    tpl: '<div class="pull-right"><button class="btn btn-link" onclick="logout()">ç™»å‡º</button></div>'
                },
                body: {
                    type: 'grid',
                    columns: [
                        {
                            md: 3,
                            body: {
                                type: 'wrapper',
                                className: 'bg-light padder-v',
                                body: {
                                    type: 'nav',
                                    stacked: true,
                                    className: 'nav-pills nav-stacked',
                                    links: [
                                        {
                                            label: 'é¦–é¡µ',
                                            icon: 'fa fa-home',
                                            active: currentHash === '/home',
                                            onClick: {
                                                actionType: 'url',
                                                url: '#/home',
                                                blank: false
                                            }
                                        },
                                        {
                                            label: 'ç”¨æˆ·ç®¡ç†',
                                            icon: 'fa fa-users',
                                            active: currentHash === '/users',
                                            onClick: {
                                                actionType: 'url',
                                                url: '#/users',
                                                blank: false
                                            }
                                        },
                                        {
                                            label: 'RSSæºç®¡ç†',
                                            icon: 'fa fa-rss',
                                            active: currentHash === '/sources',
                                            onClick: {
                                                actionType: 'url',
                                                url: '#/sources',
                                                blank: false
                                            }
                                        },
                                        {
                                            label: 'å†…å®¹ç®¡ç†',
                                            icon: 'fa fa-newspaper-o',
                                            active: currentHash === '/contents',
                                            onClick: {
                                                actionType: 'url',
                                                url: '#/contents',
                                                blank: false
                                            }
                                        },
                                        {
                                            label: 'ç³»ç»Ÿç›‘æ§',
                                            icon: 'fa fa-dashboard',
                                            active: currentHash === '/system',
                                            onClick: {
                                                actionType: 'url',
                                                url: '#/system',
                                                blank: false
                                            }
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            md: 9,
                            body: [
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/home"`,
                                    body: getHomePageConfig().body
                                },
                                {
                                    type: 'wrapper', 
                                    visibleOn: `window.location.hash === "#/users"`,
                                    body: getUsersPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/sources"`, 
                                    body: getSourcesPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/contents"`,
                                    body: getContentsPageConfig().body
                                },
                                {
                                    type: 'wrapper',
                                    visibleOn: `window.location.hash === "#/system"`,
                                    body: getSystemPageConfig().body
                                }
                            ]
                        }
                    ]
                }
            };

            debugLog('å¼€å§‹æ¸²æŸ“AMISé¡µé¢', 'info');
            
            try {
                const amis = amisRequire('amis/embed');
                
                // æ¸…ç†æ—§å®ä¾‹
                if (amisInstance) {
                    debugLog('æ¸…ç†æ—§AMISå®ä¾‹', 'info');
                    const rootElement = document.getElementById('root');
                    rootElement.innerHTML = '';
                }
                
                amisInstance = amis.embed('#root', mainPageConfig, {}, fetcher);
                debugLog('AMISé¡µé¢æ¸²æŸ“æˆåŠŸ', 'success');
                
            } catch (error) {
                debugLog(`AMISæ¸²æŸ“é”™è¯¯: ${error.message}`, 'error');
                console.error('AMISæ¸²æŸ“é”™è¯¯:', error);
            }
        }

        // Hashå˜åŒ–å¤„ç†
        function handleHashChange() {
            debugLog(`Hashå˜åŒ–: ${window.location.hash}`, 'info');
            renderMainPage();
        }

        // ç™»å‡ºå‡½æ•°
        function logout() {
            debugLog('ç”¨æˆ·ç™»å‡º', 'info');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_logged_in');
            window.location.reload();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            debugLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            debugLog(`åˆå§‹Hash: ${window.location.hash}`, 'info');
            debugLog(`Tokenå­˜åœ¨: ${!!getToken()}`, 'info');
            
            if (getToken()) {
                debugLog('ç”¨æˆ·å·²ç™»å½•ï¼Œåˆå§‹åŒ–ä¸»é¡µé¢', 'success');
                renderMainPage();
                window.addEventListener('hashchange', handleHashChange);
            } else {
                debugLog('ç”¨æˆ·æœªç™»å½•', 'warning');
                window.location.href = '/';
            }
        });

        // æ·»åŠ é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
        window.addEventListener('click', function(event) {
            clickCount++;
            debugLog(`å…¨å±€ç‚¹å‡»äº‹ä»¶ #${clickCount}: ${event.target.tagName}.${event.target.className}`, 'info');
        });
    </script>
</body>
</html>