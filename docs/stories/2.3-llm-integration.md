# Story 2.3: LLM集成与Markdown生成

## Status
Not Started

## Story
**As a** 用户,
**I want** 系统能利用AI模型分析文章并生成Markdown笔记,
**so that** 我可以获得经过AI处理的、结构化的新闻摘要和分析报告

## Acceptance Criteria
- [ ] 集成智谱AI GLM-4.5-Flash模型进行内容分析
- [ ] 实现智能文本摘要功能，提取文章核心内容
- [ ] 生成结构化的Markdown格式文档
- [ ] 支持多种AI处理模式（摘要、分析、关键词提取等）
- [ ] 确保生成的Markdown文件格式规范，便于阅读和同步
- [ ] 实现AI处理失败的重试机制
- [ ] 支持处理结果的个性化配置（语言、风格、详细程度）

## Tasks / Subtasks
- [ ] Task 1: 集成智谱AI服务 (AC: 1, 6)
  - [ ] 配置智谱AI API Key和环境变量
  - [ ] 创建AI服务封装类
  - [ ] 实现智谱GLM-4.5-Flash模型调用和错误处理
  - [ ] 添加AI使用量统计和限制
- [ ] Task 2: 实现内容分析功能 (AC: 2, 4, 7)
  - [ ] 创建文本摘要算法
  - [ ] 实现关键词提取功能
  - [ ] 开发内容分类和标签生成
  - [ ] 支持个性化处理配置
- [ ] Task 3: 实现Markdown生成器 (AC: 3, 5)
  - [ ] 设计Markdown模板系统
  - [ ] 实现结构化文档生成
  - [ ] 添加元数据和格式化
  - [ ] 确保与Obsidian等工具兼容
- [ ] Task 4: 集成到处理管道 (AC: 1, 3, 6)
  - [ ] 将AI处理器集成到队列消费者
  - [ ] 实现处理状态跟踪
  - [ ] 添加重试和错误恢复机制
  - [ ] 性能优化和资源管理
- [ ] Task 5: 用户配置和个性化 (AC: 7)
  - [ ] 创建AI处理偏好设置
  - [ ] 实现语言选择功能
  - [ ] 支持输出风格定制
  - [ ] 添加处理历史和反馈机制

## Dev Notes

### 技术架构信息
- **AI服务**: 智谱AI GLM-4.5-Flash模型 [Source: 现有实现]
- **处理模型**: 文本摘要、内容分析、关键词提取
- **输出格式**: Markdown with frontmatter
- **队列集成**: 与现有队列系统集成
- **存储**: 生成的Markdown文件存储到Cloudflare R2

### 数据模型信息
```typescript
// AI处理配置
interface AIProcessingConfig {
  id: string;
  userId: string;
  language: 'zh-CN' | 'en-US' | 'auto';
  style: 'concise' | 'detailed' | 'academic';
  maxTokens: number;
  includeKeywords: boolean;
  includeSummary: boolean;
  includeAnalysis: boolean;
  templateId?: string;
  createdAt: Date;
  updatedAt: Date;
}

// 处理结果
interface ProcessingResult {
  id: string;
  sourceId: string;
  userId: string;
  originalUrl: string;
  title: string;
  content: string;
  summary: string;
  keywords: string[];
  categories: string[];
  markdownContent: string;
  processingTime: number;
  aiTokensUsed: number;
  status: 'completed' | 'failed' | 'processing';
  error?: string;
  createdAt: Date;
  completedAt?: Date;
}

// Markdown模板
interface MarkdownTemplate {
  id: string;
  name: string;
  description: string;
  template: string;
  variables: string[];
  isDefault: boolean;
  createdAt: Date;
}
```

### API规范信息
```typescript
// AI处理服务接口
interface AIProcessingService {
  analyzeContent(params: {
    content: string;
    title: string;
    config: AIProcessingConfig;
  }): Promise<ProcessingResult>;
  
  generateMarkdown(result: ProcessingResult): Promise<string>;
  
  validateConfig(config: AIProcessingConfig): Promise<boolean>;
}

// 配置管理接口
interface ConfigService {
  getUserConfig(userId: string): Promise<AIProcessingConfig>;
  updateConfig(userId: string, config: Partial<AIProcessingConfig>): Promise<void>;
  createDefaultConfig(userId: string): Promise<AIProcessingConfig>;
}
```

### 技术栈信息
- **AI服务**: 智谱AI GLM-4.5-Flash模型 (免费、中文优化)
- **后端框架**: Hono.js 4.4 with TypeScript [Source: architecture.md#3]
- **数据库**: Cloudflare D1 with Drizzle ORM [Source: architecture.md#3]
- **文件存储**: Cloudflare R2 [Source: architecture.md#3]
- **队列系统**: Cloudflare Queues [Source: architecture.md#3]
- **模板引擎**: Handlebars或自定义模板系统

### 文件路径和命名约定
- AI服务: `/backend/src/services/ai/`
  - `ai-service.ts` - AI服务封装
  - `markdown-generator.ts` - Markdown生成器
  - `content-analyzer.ts` - 内容分析器
  - `types.ts` - 类型定义
- 配置管理: `/backend/src/services/config/`
  - `config.service.ts` - 配置管理服务
- 队列处理器: `/backend/src/workers/ai-processor.ts`
- 数据库schema: `/backend/src/db/schema.ts` (更新)
- 模板文件: `/backend/src/templates/`

### 技术约束
- AI模型调用必须在30秒内完成（智谱API限制）
- 生成的Markdown文件大小必须合理（建议小于1MB）
- 必须实现AI使用量的限制和监控
- 必须处理AI服务的不可用情况和降级策略
- 支持多种语言和个性化配置

## Testing

### 测试标准
- AI内容分析功能正常
- Markdown生成格式正确
- 个性化配置有效应用
- 错误处理和重试机制正常
- 性能满足系统要求
- 与现有系统组件正确集成

### 测试框架和模式
- **单元测试**: 使用Vitest测试AI服务和Markdown生成器
- **集成测试**: 使用Playwright测试端到端处理流程
- **Mock测试**: 模拟AI服务响应进行测试
- **性能测试**: 测试AI处理速度和资源使用

### 测试用例示例
```typescript
// AI服务测试示例
describe('AI Processing Service', () => {
  it('should analyze content and generate summary', async () => {
    const aiService = new AIProcessingService();
    const result = await aiService.analyzeContent({
      content: testContent,
      title: 'Test Article',
      config: testConfig
    });
    
    expect(result.summary).toBeDefined();
    expect(result.keywords).toBeInstanceOf(Array);
    expect(result.status).toBe('completed');
  });

  it('should generate valid markdown format', async () => {
    const generator = new MarkdownGenerator();
    const markdown = await generator.generate(testResult);
    
    expect(markdown).toContain('---'); // frontmatter
    expect(markdown).toContain('# '); // heading
    expect(markdown).toContain('## '); // subheading
  });
});
```

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. 待开发 - 配置智谱AI API Key和环境变量
2. 待开发 - 实现智谱AI服务封装类
3. 待开发 - 开发内容分析和摘要算法
4. 待开发 - 实现Markdown生成器
5. 待开发 - 集成到队列处理系统
6. 待开发 - 实现用户配置管理
7. 待开发 - 性能优化和错误处理

### Completion Notes List
1. 待完成 - 智谱AI配置和集成
2. 待完成 - AI服务封装类实现
3. 待完成 - 内容分析功能开发
4. 待完成 - Markdown生成器实现
5. 待完成 - 模板系统开发
6. 待完成 - 用户配置管理
7. 待完成 - 队列集成和状态跟踪
8. 待完成 - 测试和性能优化

### File List
- `/backend/src/services/llm-extractor.ts` (待更新)
- `/backend/src/services/llm-content-extractor.ts` (待更新)
- `/backend/src/services/config/config.service.ts` (待创建)
- `/backend/src/workers/ai-processor.ts` (待更新)
- `/backend/src/db/schema.ts` (待更新)
- `/backend/src/templates/` (待创建)
- `/backend/test/ai-processing.test.ts` (待创建)

### Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## QA Results
### QA Agent Used
待定

### QA Checklist
- [ ] 智谱AI配置正确
- [ ] AI内容分析功能正常
- [ ] Markdown生成格式正确
- [ ] 个性化配置有效应用
- [ ] 错误处理和重试机制正常
- [ ] 处理状态跟踪准确
- [ ] 性能满足系统要求
- [ ] 与现有系统正确集成
- [ ] 用户配置管理功能正常
- [ ] 文档完整准确

### QA Notes
待开发完成后的QA测试记录

### QA Status
待开发 - Not Started