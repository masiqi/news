# Story 1.2: 用户注册与环境配置

## Status
Draft

## Story
**As a** 新访客,
**I want** 使用邮箱和密码注册账户,
**so that** 我可以开始使用服务

## Acceptance Criteria
- [ ] 用户可以通过Web界面输入邮箱和密码进行注册
- [ ] 系统需要验证邮箱格式的有效性
- [ ] 系统需要验证密码强度（至少8位，包含字母和数字）
- [ ] 系统需要检查邮箱是否已被注册
- [ ] 注册成功后，系统自动为用户在Cloudflare R2中创建唯一的、隔离的存储目录
- [ ] 用户注册成功后，系统自动跳转到登录页面

## Tasks / Subtasks
- [ ] Task 1: 设计注册页面UI (AC: 1)
  - [ ] 创建注册页面组件
  - [ ] 添加邮箱输入框
  - [ ] 添加密码输入框
  - [ ] 添加注册按钮
- [ ] Task 2: 实现注册表单验证 (AC: 2, 3)
  - [ ] 实现邮箱格式验证
  - [ ] 实现密码强度验证
- [ ] Task 3: 实现后端注册API (AC: 1, 4)
  - [ ] 创建POST /auth/register端点
  - [ ] 实现邮箱重复性检查
  - [ ] 实现用户密码安全存储（使用bcrypt等加密）
- [ ] Task 4: 实现用户存储目录自动创建 (AC: 5)
  - [ ] 在用户注册成功后，调用Cloudflare R2 API创建用户专属目录
  - [ ] 确保目录命名唯一且无法被其他用户猜测
- [ ] Task 5: 实现注册成功跳转 (AC: 6)
  - [ ] 注册成功后重定向到登录页面
  - [ ] 显示注册成功的提示信息

## Dev Notes

### 数据模型信息
- **`User`**: 存储用户账户信息 [Source: architecture.md#4]
- 需要包含字段：id, email, password_hash, created_at等基础字段

### API规范信息
- 需要实现POST /auth/register端点 [Source: architecture.md#5]
- 该端点用于处理用户注册请求

### 技术栈信息
- **前端框架**: Next.js ~15.0 [Source: architecture.md#3]
- **后端框架**: Hono.js ~4.4 [Source: architecture.md#3]
- **数据库**: Cloudflare D1 [Source: architecture.md#3]
- **ORM**: Drizzle ORM ~0.30 [Source: architecture.md#3]
- **认证模式**: JWT [Source: architecture.md#3]
- **文件存储**: Cloudflare R2 [Source: architecture.md#3]

### 文件路径和命名约定
- 前端注册页面组件：frontend/pages/register.tsx（假设使用Pages Router）
- 后端注册API路由：backend/routes/auth.ts
- 用户模型：packages/db/models/user.ts
- 数据库模式：packages/db/schema/users.ts

### 测试要求
- 需要验证邮箱格式验证功能
- 需要验证密码强度验证功能
- 需要验证邮箱重复性检查功能
- 需要验证用户注册成功后的R2目录创建功能
- 需要验证注册成功后的页面跳转功能

### 技术约束
- 必须确保用户密码安全存储，使用适当的加密算法（如bcrypt）
- 必须确保用户R2存储目录的唯一性和隔离性
- 必须遵循JWT认证模式进行用户会话管理

### 安全性要求
- 用户密码必须加密存储，不能明文保存
- 必须实现适当的输入验证，防止SQL注入等攻击
- 必须确保用户数据的多租户隔离 [Source: prd.md#NFR1]

## Testing

### 测试标准
- 邮箱格式验证正确性
- 密码强度验证正确性
- 邮箱重复性检查功能
- 用户注册流程完整性
- R2目录自动创建功能
- 注册成功后的页面跳转

### 测试框架和模式
- 使用Vitest进行单元测试 [Source: architecture.md#3]
- 使用Playwright进行端到端测试 [Source: architecture.md#3]
- 需要测试各种边界情况和异常情况

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-02 | 1.0 | Initial draft | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_This section will be populated by the development agent during implementation_

### Completion Notes List
_This section will be populated by the development agent during implementation_

### File List
_This section will be populated by the development agent during implementation_

## QA Results
_This section will be populated by the QA agent during review_