# Story 4.1: 管理后台脚手架

## Status
Not Started

## Story
**As a** 开发者,
**I want** 一个基于Amis的管理后台项目，
**so that** 我可以快速搭建管理界面

## Acceptance Criteria
- [ ] 创建基于Amis的管理后台基础项目结构
- [ ] 实现管理员身份验证和登录功能
- [ ] 配置管理后台路由和导航系统
- [ ] 集成Amis UI组件库和主题系统
- [ ] 实现与后端API的连接和数据交互
- [ ] 创建基础的页面布局和侧边栏导航
- [ ] 确保管理后台的安全性访问控制

## Tasks / Subtasks
- [ ] Task 1: 搭建管理后台项目结构 (AC: 1, 4)
  - [ ] 创建admin目录和基础文件结构
  - [ ] 配置package.json和依赖项
  - [ ] 集成Amis框架和相关依赖
  - [ ] 设置构建和开发环境配置
- [ ] Task 2: 实现管理员身份验证 (AC: 2, 7)
  - [ ] 创建管理员登录页面
  - [ ] 实现JWT token验证机制
  - [ ] 配置路由守卫和权限拦截
  - [ ] 实现登录状态管理和退出功能
- [ ] Task 3: 配置路由和导航系统 (AC: 3, 6)
  - [ ] 设计管理后台路由结构
  - [ ] 创建侧边栏导航组件
  - [ ] 实现面包屑导航
  - [ ] 配置路由懒加载和权限控制
- [ ] Task 4: 集成Amis UI系统 (AC: 4, 6)
  - [ ] 配置Amis主题和样式
  - [ ] 创建基础布局组件
  - [ ] 实现响应式设计
  - [ ] 集成Amis组件库和表单构建器
- [ ] Task 5: 实现API集成 (AC: 5)
  - [ ] 创建API请求封装层
  - [ ] 实现数据交互和状态管理
  - [ ] 配置错误处理和加载状态
  - [ ] 实现API请求拦截和响应处理
- [ ] Task 6: 安全性配置 (AC: 2, 7)
  - [ ] 实现访问控制和权限验证
  - [ ] 配置CORS和安全头
  - [ ] 实现审计日志记录
  - [ ] 添加安全防护措施

## Dev Notes

### 技术架构信息
- **管理后台框架**: Amis (低代码前端框架)
- **身份验证**: JWT Token + 路由守卫
- **UI组件**: Amis内置组件库
- **状态管理**: Redux/MobX或Amis内置状态管理
- **API集成**: Axios + 请求拦截器
- **构建工具**: Webpack/Vite

### 数据模型信息
```typescript
// 管理员用户
interface AdminUser {
  id: string;
  username: string;
  email: string;
  role: 'super_admin' | 'admin' | 'operator';
  permissions: string[];
  isActive: boolean;
  lastLoginAt?: Date;
  createdAt: Date;
  updatedAt: Date;
}

// 管理员权限
interface AdminPermission {
  id: string;
  name: string;
  description: string;
  resource: string;
  action: 'create' | 'read' | 'update' | 'delete';
  conditions?: Record<string, any>;
}

// 管理员登录日志
interface AdminLoginLog {
  id: string;
  adminId: string;
  ipAddress: string;
  userAgent: string;
  loginTime: Date;
  status: 'success' | 'failed';
  failureReason?: string;
}

// 系统配置
interface SystemConfig {
  id: string;
  key: string;
  value: any;
  type: 'string' | 'number' | 'boolean' | 'json';
  description: string;
  isPublic: boolean;
  updatedAt: Date;
  updatedBy: string;
}
```

### API规范信息
```typescript
// 管理员认证API
interface AdminAuthAPI {
  // 管理员登录
  POST /api/admin/auth/login: {
    body: { username: string; password: string };
    response: { token: string; user: AdminUser };
  }
  
  // 管理员登出
  POST /api/admin/auth/logout: {
    response: { success: boolean };
  }
  
  // 获取当前管理员信息
  GET /api/admin/auth/me: {
    response: { user: AdminUser };
  }
  
  // 刷新Token
  POST /api/admin/auth/refresh: {
    response: { token: string };
  }
}

// 系统配置API
interface SystemConfigAPI {
  // 获取系统配置
  GET /api/admin/config: {
    query: { keys?: string[] };
    response: { configs: SystemConfig[] };
  }
  
  // 更新系统配置
  PUT /api/admin/config/:id: {
    body: { value: any };
    response: { config: SystemConfig };
  }
}
```

### 技术栈信息
- **前端框架**: Amis (基于React的低代码框架)
- **语言**: TypeScript
- **样式**: CSS-in-JS + SCSS
- **构建工具**: Vite 或 Webpack
- **HTTP客户端**: Axios
- **状态管理**: Amis内置状态管理或Redux
- **路由**: React Router
- **UI组件**: Amis组件库

### 文件路径和命名约定
- 管理后台根目录: `/admin/`
  - `package.json` - 项目依赖配置
  - `vite.config.ts` 或 `webpack.config.js` - 构建配置
  - `tsconfig.json` - TypeScript配置
  - `index.html` - 入口HTML文件
- 源代码: `/admin/src/`
  - `main.tsx` - 应用入口文件
  - `App.tsx` - 根组件
  - `auth/` - 认证相关组件
  - `layouts/` - 布局组件
  - `pages/` - 页面组件
  - `components/` - 通用组件
  - `utils/` - 工具函数
  - `api/` - API封装
  - `store/` - 状态管理
  - `styles/` - 样式文件
- 配置文件: `/admin/config/`
  - `routes.ts` - 路由配置
  - `menu.ts` - 菜单配置
  - `permissions.ts` - 权限配置
  - `theme.ts` - 主题配置

### 技术约束
- 必须使用Amis框架作为管理后台基础
- 必须实现严格的身份验证和权限控制
- 必须支持响应式设计和移动端访问
- 必须与现有后端API兼容
- 必须实现安全的访问控制机制

## Testing

### 测试标准
- 管理后台项目结构正确
- 身份验证功能正常
- 路由和导航系统工作正常
- Amis组件集成成功
- API连接和数据交互正常
- 安全性访问控制有效

### 测试框架和模式
- **单元测试**: 使用Vitest或Jest测试组件和工具函数
- **集成测试**: 使用Playwright测试完整的用户流程
- **安全测试**: 使用安全测试工具验证认证和权限
- **性能测试**: 测试管理后台的加载和响应速度

### 测试用例示例
```typescript
// 管理后台认证测试示例
describe('Admin Authentication', () => {
  it('should login with valid credentials', async () => {
    const response = await request(app)
      .post('/api/admin/auth/login')
      .send({
        username: 'admin',
        password: 'password123'
      });
    
    expect(response.status).toBe(200);
    expect(response.body.token).toBeDefined();
    expect(response.body.user.role).toBe('admin');
  });

  it('should reject access without authentication', async () => {
    const response = await request(app)
      .get('/api/admin/config');
    
    expect(response.status).toBe(401);
  });
});

// Amis组件集成测试
describe('Amis Integration', () => {
  it('should render Amis components correctly', async () => {
    const page = await browser.newPage();
    await page.goto('/admin/login');
    
    const loginForm = await page.$('[data-testid="login-form"]');
    expect(loginForm).toBeTruthy();
    
    const usernameInput = await page.$('input[name="username"]');
    expect(usernameInput).toBeTruthy();
  });
});
```

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. 待开发 - 创建管理后台项目结构
2. 待开发 - 集成Amis框架和依赖
3. 待开发 - 实现管理员身份验证
4. 待开发 - 配置路由和导航系统
5. 待开发 - 集成Amis UI组件系统
6. 待开发 - 实现API连接和数据交互
7. 待开发 - 配置安全性访问控制

### Completion Notes List
1. 待完成 - 管理后台项目结构搭建
2. 待完成 - Amis框架集成和配置
3. 待完成 - 管理员身份验证实现
4. 待完成 - 路由和导航系统配置
5. 待完成 - Amis UI组件集成
6. 待完成 - API连接和数据交互实现
7. 待完成 - 响应式设计和优化
8. 待完成 - 安全性配置和测试

### File List
- `/admin/package.json` (待创建)
- `/admin/vite.config.ts` (待创建)
- `/admin/tsconfig.json` (待创建)
- `/admin/index.html` (待创建)
- `/admin/src/main.tsx` (待创建)
- `/admin/src/App.tsx` (待创建)
- `/admin/src/auth/LoginPage.tsx` (待创建)
- `/admin/src/layouts/MainLayout.tsx` (待创建)
- `/admin/src/components/SidebarNav.tsx` (待创建)
- `/admin/src/api/admin.ts` (待创建)
- `/admin/config/routes.ts` (待创建)
- `/admin/config/menu.ts` (待创建)

### Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## QA Results
### QA Agent Used
待定

### QA Checklist
- [ ] 管理后台项目结构正确
- [ ] 身份验证功能正常
- [ ] 路由和导航系统工作正常
- [ ] Amis组件集成成功
- [ ] API连接和数据交互正常
- [ ] 安全性访问控制有效
- [ ] 响应式设计通过测试
- [ ] 构建和部署配置正确
- [ ] 性能测试通过
- [ ] 安全性测试通过

### QA Notes
待开发完成后的QA测试记录

### QA Status
待开发 - Not Started