# Story 1.6: RSS内容缓存与共享处理优化

## Status
Ready for Implementation

## Story
**As a** 平台用户,
**I want** 系统能够共享处理过的RSS内容,
**so that** 避免重复处理相同内容，节省计算资源和费用

## Acceptance Criteria
- [ ] 系统能够缓存已处理的RSS条目内容
- [ ] 多个用户订阅相同RSS源时，内容只处理一次
- [ ] 处理后的内容可以被多个用户共享使用
- [ ] 系统能够跟踪RSS条目的处理状态
- [ ] 用户可以获得基于共享内容的个性化处理结果

## Tasks / Subtasks
- [x] Task 1: 扩展数据库schema支持内容缓存 (AC: 1, 4)
  - [x] 创建rss_entries表存储原始RSS条目
  - [x] 创建processed_contents表存储已处理内容
  - [x] 添加处理状态跟踪字段
- [in_progress] Task 2: 实现内容处理优化服务 (AC: 1, 2, 3, 4, 5)
  - [x] 创建内容缓存服务，检查是否已处理过相同内容
  - [x] 实现共享处理逻辑，避免重复处理
  - [x] 实现个性化内容生成机制
- [in_progress] Task 3: 更新RSS处理工作流 (AC: 1, 2, 3, 4, 5)
  - [x] 修改RSS抓取逻辑，先检查缓存
  - [x] 实现处理结果共享机制
  - [x] 更新内容存储逻辑，支持共享和个性化
- [in_progress] Task 4: 实现处理状态管理 (AC: 4)
  - [x] 创建处理状态跟踪机制
  - [x] 实现失败重试机制
  - [x] 添加处理时间监控

## Dev Notes

### 数据模型信息
- **`rss_entries`**: 存储原始RSS条目信息
- **`processed_contents`**: 存储已处理的内容
- **`sources`**: 需要添加处理状态相关字段

### API规范信息
- 需要扩展现有的RSS处理API
- 需要添加内容缓存检查接口

### 技术栈信息
- **前端框架**: Next.js ~15.0 [Source: architecture.md#3]
- **后端框架**: Hono.js ~4.4 [Source: architecture.md#3]
- **数据库**: Cloudflare D1 [Source: architecture.md#3]
- **ORM**: Drizzle ORM ~0.30 [Source: architecture.md#3]
- **对象存储**: Cloudflare R2 [Source: architecture.md#3]
- **AI处理**: Cloudflare Workers AI [Source: architecture.md#3]

### 文件路径和命名约定
- 数据库schema：backend/src/db/schema.ts
- 数据库迁移：backend/src/db/migrations/
- 数据库类型定义：backend/src/db/types.ts
- 后端服务层：backend/src/services/content-cache.service.ts
- RSS处理worker：backend/src/workers/rss-fetcher.ts
- AI处理worker：backend/src/workers/ai-processor.ts

### 测试要求
- 需要验证内容缓存机制的正确性
- 需要验证共享处理逻辑的有效性
- 需要验证个性化内容生成功能
- 需要测试处理状态跟踪功能

### 技术约束
- 必须确保内容处理只执行一次
- 必须支持个性化内容生成
- 必须正确处理失败情况和重试机制

### 安全性要求
- 必须确保用户数据的多租户隔离 [Source: prd.md#NFR1]
- 必须保护已处理内容不被未授权访问

## Testing

### 测试标准
- 内容缓存机制正确性
- 共享处理逻辑有效性
- 个性化内容生成功能
- 处理状态跟踪准确性

### 测试框架和模式
- 使用Vitest进行单元测试 [Source: architecture.md#3]
- 使用Playwright进行端到端测试 [Source: architecture.md#3]
- 需要测试各种边界情况和异常情况
- 需要测试性能优化效果

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-03 | 1.0 | Initial draft | Bob (Scrum Master) |

## Dev Agent Record
记录了Story 1.6的初步实现过程，包括数据库schema扩展、服务层创建等。

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- 数据库schema扩展完成
- 内容缓存服务创建完成
- 迁移文件创建完成

### Completion Notes List
1. 成功扩展了数据库schema，添加了rss_entries、processed_contents和user_notes表
2. 创建了ContentCacheService服务层，提供了内容缓存和共享处理功能
3. 创建了数据库迁移文件，用于更新生产环境数据库
4. 更新了数据库类型定义文件，提供TypeScript类型支持
5. 创建了RSS抓取worker，实现缓存检查和队列处理
6. 创建了AI处理器worker，实现内容处理和结果缓存
7. 实现了处理状态跟踪机制和处理时间监控

### File List
- backend/src/db/schema.ts
- backend/src/db/migrations/0003_add_rss_content_caching_tables.sql
- backend/src/db/types.ts
- backend/src/services/content-cache.service.ts
- backend/src/workers/rss-fetcher.ts
- backend/src/workers/ai-processor.ts

## QA Results
正在进行中，已完成数据库schema扩展和服务层创建。