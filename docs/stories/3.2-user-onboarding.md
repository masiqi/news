# Story 3.2: 新用户兴趣引导流程

## Status
Not Started

## Story
**As a** 新用户,
**I want** 在注册后被引导选择兴趣，以便系统为我推荐资讯源,
**so that** 我可以快速获得符合个人兴趣的新闻内容，提升使用体验

## Acceptance Criteria
- [ ] 在用户注册成功后自动触发兴趣引导流程
- [ ] 提供直观的兴趣选择界面，支持多种兴趣分类
- [ ] 基于用户选择的兴趣智能推荐合适的RSS源
- [ ] 支持兴趣的多选和优先级设置
- [ ] 提供推荐源的预览和确认功能
- [ ] 允许用户跳过引导流程，稍后在设置中完成
- [ ] 保存用户兴趣偏好用于个性化推荐

## Tasks / Subtasks
- [ ] Task 1: 设计兴趣分类体系 (AC: 2, 7)
  - [ ] 设计多层次兴趣分类结构
  - [ ] 创建兴趣与RSS源的映射关系
  - [ ] 实现兴趣权重和优先级机制
  - [ ] 开发兴趣推荐算法
- [ ] Task 2: 实现后端引导逻辑 (AC: 1, 3, 7)
  - [ ] 创建兴趣引导状态管理
  - [ ] 开发兴趣推荐API
  - [ ] 实现兴趣偏好保存功能
  - [ ] 集成到用户注册流程
- [ ] Task 3: 开发引导界面组件 (AC: 1, 2, 4, 5, 6)
  - [ ] 创建兴趣选择引导页面
  - [ ] 实现兴趣分类展示组件
  - [ ] 开发RSS源推荐预览组件
  - [ ] 实现确认和跳过功能
  - [ ] 添加进度指示和引导提示
- [ ] Task 4: 实现推荐算法 (AC: 3, 7)
  - [ ] 开发基于兴趣的RSS源推荐算法
  - [ ] 实现推荐源质量评分机制
  - [ ] 添加推荐结果个性化排序
  - [ ] 支持推荐结果的A/B测试
- [ ] Task 5: 集成和优化 (AC: 1, 6, 7)
  - [ ] 将引导流程集成到注册后的用户旅程
  - [ ] 实现引导流程的触发和状态管理
  - [ ] 优化用户界面和交互体验
  - [ ] 添加用户行为分析和反馈收集

## Dev Notes

### 技术架构信息
- **引导流程**: 多步骤引导界面，支持跳过和重新进入
- **兴趣分类**: 层次化分类结构，支持多选和权重
- **推荐算法**: 基于兴趣匹配和源质量评分的混合推荐
- **状态管理**: 引导流程状态和用户偏好持久化
- **集成**: 与用户注册、RSS源管理、推荐系统集成

### 数据模型信息
```typescript
// 兴趣分类
interface InterestCategory {
  id: string;
  name: string;
  description: string;
  icon?: string;
  color?: string;
  parentId?: string; // 支持层次分类
  sortOrder: number;
  isActive: boolean;
  relatedTags: string[];
  createdAt: Date;
  updatedAt: Date;
}

// 用户兴趣偏好
interface UserInterest {
  id: string;
  userId: string;
  categoryId: string;
  level: 'low' | 'medium' | 'high'; // 兴趣程度
  priority: number; // 优先级 1-10
  selectedAt: Date;
  isActive: boolean;
}

// 兴趣与RSS源映射
interface InterestSourceMapping {
  id: string;
  categoryId: string;
  sourceId: string;
  relevanceScore: number; // 相关性评分 0-100
  matchScore: number; // 匹配度评分 0-100
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

// 引导流程状态
interface OnboardingStatus {
  id: string;
  userId: string;
  step: 'welcome' | 'interests' | 'recommendations' | 'confirmation' | 'completed' | 'skipped';
  currentStep: number;
  totalSteps: number;
  startedAt: Date;
  completedAt?: Date;
  selectedInterests: string[];
  recommendedSources: string[];
  confirmedSources: string[];
}
```

### API规范信息
```typescript
// 兴趣引导API
interface OnboardingAPI {
  // 获取兴趣分类
  GET /api/onboarding/categories: {
    response: { categories: InterestCategory[] };
  }
  
  // 获取推荐RSS源
  POST /api/onboarding/recommendations: {
    body: { interests: { categoryId: string; level: 'low' | 'medium' | 'high' }[] };
    response: { recommendations: RecommendedSource[] };
  }
  
  // 保存用户兴趣偏好
  POST /api/onboarding/interests: {
    body: { interests: { categoryId: string; level: 'low' | 'medium' | 'high' }[] };
    response: { success: boolean };
  }
  
  // 确认推荐的RSS源
  POST /api/onboarding/confirm-sources: {
    body: { sourceIds: string[] };
    response: { success: boolean; importedCount: number };
  }
  
  // 更新引导状态
  PUT /api/onboarding/status: {
    body: { step: string; data?: any };
    response: { status: OnboardingStatus };
  }
  
  // 跳过引导流程
  POST /api/onboarding/skip: {
    response: { success: boolean };
  }
}
```

### 技术栈信息
- **前端框架**: Next.js 15 with TypeScript [Source: architecture.md#3]
- **后端框架**: Hono.js 4.4 with TypeScript [Source: architecture.md#3]
- **数据库**: Cloudflare D1 with Drizzle ORM [Source: architecture.md#3]
- **状态管理**: React Query + Zustand
- **UI组件**: Tailwind CSS + Headless UI + Framer Motion
- **样式**: CSS-in-JS + 响应式设计

### 文件路径和命名约定
- 引导页面: `/frontend/src/app/onboarding/`
  - `page.tsx` - 引导主页面
  - `interests/page.tsx` - 兴趣选择页面
  - `recommendations/page.tsx` - 推荐源预览页面
  - `confirmation/page.tsx` - 确认页面
- 引导组件: `/frontend/src/components/onboarding/`
  - `InterestSelector.tsx` - 兴趣选择组件
  - `CategoryTree.tsx` - 分类树组件
  - `SourcePreview.tsx` - 推荐源预览组件
  - `ProgressIndicator.tsx` - 进度指示器
- 后端API: `/backend/src/routes/onboarding.ts`
- 服务层: `/backend/src/services/onboarding/`
  - `onboarding.service.ts` - 引导服务
  - `recommendation.service.ts` - 推荐服务
  - `interest.service.ts` - 兴趣服务
- 数据库: `/backend/src/db/schema.ts` (扩展)

### 技术约束
- 引导流程必须支持中断和恢复
- 兴趣选择必须直观且易于理解
- 推荐算法必须准确且高效
- 界面必须响应式且支持移动设备
- 必须支持跳过和稍后完成功能

## Testing

### 测试标准
- 引导流程触发机制正常
- 兴趣选择功能完整且准确
- 推荐算法结果合理
- 用户偏好保存成功
- 界面在各种设备上正常显示
- 跳过和恢复功能正常

### 测试框架和模式
- **单元测试**: 使用Vitest测试推荐算法和业务逻辑
- **集成测试**: 使用Playwright测试完整的引导流程
- **用户测试**: A/B测试不同的引导界面设计
- **性能测试**: 测试推荐算法的性能和响应时间

### 测试用例示例
```typescript
// 引导流程测试示例
describe('User Onboarding Flow', () => {
  it('should start onboarding after registration', async () => {
    const user = await createTestUser();
    await login(user);
    
    const page = await browser.newPage();
    await page.goto('/dashboard');
    
    // 验证是否自动重定向到引导流程
    expect(page.url()).toContain('/onboarding');
  });

  it('should recommend sources based on interests', async () => {
    const response = await request(app)
      .post('/api/onboarding/recommendations')
      .send({
        interests: [
          { categoryId: 'tech', level: 'high' },
          { categoryId: 'ai', level: 'medium' }
        ]
      });
    
    expect(response.status).toBe(200);
    expect(response.body.recommendations.length).toBeGreaterThan(0);
    expect(response.body.recommendations[0].relevanceScore).toBeGreaterThan(70);
  });
});
```

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. 待开发 - 设计兴趣分类体系和数据模型
2. 待开发 - 实现引导流程后端逻辑
3. 待开发 - 开发引导界面组件
4. 待开发 - 实现推荐算法
5. 待开发 - 集成到用户注册流程
6. 待开发 - 优化用户界面和交互体验
7. 待开发 - 添加用户行为分析

### Completion Notes List
1. 待完成 - 兴趣分类体系设计和实现
2. 待完成 - 引导流程后端API开发
3. 待完成 - 用户界面组件开发
4. 待完成 - 推荐算法实现
5. 待完成 - 用户偏好保存功能
6. 待完成 - 与用户注册流程集成
7. 待完成 - 响应式设计和优化
8. 待完成 - 测试和用户反馈收集

### File List
- `/backend/src/db/schema.ts` (待更新)
- `/backend/src/routes/onboarding.ts` (待创建)
- `/backend/src/services/onboarding/onboarding.service.ts` (待创建)
- `/backend/src/services/onboarding/recommendation.service.ts` (待创建)
- `/backend/src/services/onboarding/interest.service.ts` (待创建)
- `/frontend/src/app/onboarding/page.tsx` (待创建)
- `/frontend/src/app/onboarding/interests/page.tsx` (待创建)
- `/frontend/src/app/onboarding/recommendations/page.tsx` (待创建)
- `/frontend/src/components/onboarding/InterestSelector.tsx` (待创建)
- `/frontend/src/components/onboarding/CategoryTree.tsx` (待创建)
- `/frontend/src/components/onboarding/SourcePreview.tsx` (待创建)

### Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## QA Results
### QA Agent Used
待定

### QA Checklist
- [ ] 引导流程触发机制正常
- [ ] 兴趣选择功能完整且准确
- [ ] 推荐算法结果合理
- [ ] 用户偏好保存成功
- [ ] 界面在各种设备上正常显示
- [ ] 跳过和恢复功能正常
- [ ] 推荐源质量验证通过
- [ ] 用户数据隔离安全性验证通过
- [ ] 性能测试通过
- [ ] 用户体验测试通过

### QA Notes
待开发完成后的QA测试记录

### QA Status
待开发 - Not Started