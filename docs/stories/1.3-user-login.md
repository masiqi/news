# Story 1.3: 用户登录与会话管理

## Status
In Progress

## Story
**As a** 已注册用户,
**I want** 登录,
**so that** 我可以访问我的个人仪表盘

## Acceptance Criteria
- [x] 用户可以通过Web界面输入邮箱和密码进行登录
- [x] 系统需要验证用户提供的邮箱和密码是否匹配
- [x] 登录成功后，系统生成JWT令牌用于会话管理
- [x] 系统将JWT令牌安全地存储在客户端（如HttpOnly Cookie或localStorage）
- [x] 登录成功后，系统自动跳转到个人仪表盘页面
- [x] 登录失败时，系统显示适当的错误信息但不泄露具体原因（如"邮箱或密码错误"）

## Tasks / Subtasks
- [x] Task 1: 设计登录页面UI (AC: 1)
  - [x] 创建登录页面组件
  - [x] 添加邮箱输入框
  - [x] 添加密码输入框
  - [x] 添加登录按钮
- [x] Task 2: 实现登录表单验证 (AC: 2)
  - [x] 验证邮箱格式
  - [x] 验证密码是否为空
- [x] Task 3: 实现后端登录API (AC: 2, 3)
  - [x] 创建POST /auth/login端点
  - [x] 实现用户身份验证逻辑
  - [x] 实现JWT令牌生成
- [x] Task 4: 实现JWT令牌存储 (AC: 4)
  - [x] 在客户端安全地存储JWT令牌
  - [x] 设置适当的过期时间
- [x] Task 5: 实现登录成功跳转 (AC: 5)
  - [x] 登录成功后重定向到仪表盘页面
- [x] Task 6: 实现登录失败处理 (AC: 6)
  - [x] 显示通用错误信息
  - [x] 记录安全日志（不包含敏感信息）

## Dev Notes

### 数据模型信息
- **`User`**: 存储用户账户信息，包括邮箱和加密后的密码 [Source: architecture.md#4]

### API规范信息
- 需要实现POST /auth/login端点用于处理用户登录请求
- 需要实现JWT认证机制进行会话管理 [Source: architecture.md#3]

### 技术栈信息
- **前端框架**: Next.js ~15.0 [Source: architecture.md#3]
- **后端框架**: Hono.js ~4.4 [Source: architecture.md#3]
- **数据库**: Cloudflare D1 [Source: architecture.md#3]
- **ORM**: Drizzle ORM ~0.30 [Source: architecture.md#3]
- **认证模式**: JWT [Source: architecture.md#3]

### 文件路径和命名约定
- 前端登录页面组件：frontend/src/app/login/page.tsx
- 后端登录API路由：backend/src/routes/auth.ts
- 前端登录API路由：frontend/src/app/api/auth/login/route.ts
- 认证相关工具函数：backend/src/utils/auth.ts
- JWT配置：backend/src/config/jwt.ts

### 测试要求
- 需要验证邮箱格式验证功能
- 需要验证密码验证功能
- 需要验证用户身份验证逻辑
- 需要验证JWT令牌生成和验证
- 需要验证登录成功后的页面跳转
- 需要验证登录失败的错误处理

### 技术约束
- 必须使用JWT进行无状态会话管理
- 必须安全地存储和传输用户凭证
- 必须防止常见的安全漏洞（如SQL注入、XSS等）

### 安全性要求
- 用户密码必须加密存储，不能明文保存
- 必须实现适当的输入验证，防止SQL注入等攻击
- JWT令牌必须安全传输（通过HTTPS）和存储（HttpOnly Cookie）
- 登录失败时不能泄露具体错误原因，防止用户枚举攻击
- 必须确保用户数据的多租户隔离 [Source: prd.md#NFR1]

## Testing

### 测试标准
- 邮箱格式验证正确性
- 密码验证正确性
- 用户身份验证逻辑正确性
- JWT令牌生成和验证功能
- 登录成功后的页面跳转
- 登录失败的错误处理

### 测试框架和模式
- 使用Vitest进行单元测试 [Source: architecture.md#3]
- 使用Playwright进行端到端测试 [Source: architecture.md#3]
- 需要测试各种边界情况和异常情况
- 需要测试安全性相关场景

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-02 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-09-03 | 1.1 | Implementation in progress | James (Developer) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. 创建了frontend/src/app/login/page.tsx登录页面组件
2. 实现了邮箱和密码输入验证逻辑
3. 创建了backend/src/routes/auth.ts后端登录API路由
4. 实现了用户身份验证和JWT令牌生成（使用jsonwebtoken）
5. 创建了frontend/src/app/api/auth/login/route.ts前端API路由
6. 实现了JWT令牌的安全存储（HttpOnly Cookie）
7. 创建了frontend/src/app/dashboard/page.tsx仪表板页面组件
8. 实现了登录成功后的页面跳转功能

### Completion Notes List
1. 成功创建了登录页面UI，包含邮箱和密码输入框及登录按钮
2. 实现了前端表单验证，包括邮箱格式和密码验证
3. 实现了后端登录API，包含用户身份验证逻辑
4. 使用jsonwebtoken实现了JWT令牌生成
5. 在客户端使用HttpOnly Cookie安全地存储了JWT令牌
6. 实现了登录成功后的自动跳转到仪表板页面
7. 实现了登录失败时的通用错误信息提示
8. 创建了仪表板页面，包含登出功能

### File List
- frontend/
  - src/
    - app/
      - login/
        - page.tsx
      - dashboard/
        - page.tsx
      - api/
        - auth/
          - login/
            - route.ts
- backend/
  - src/
    - routes/
      - auth.ts

## QA Results
_This section will be populated by the QA agent during review_