# Story 2.5: 多用户R2访问控制与目录隔离

## Status
Draft

## Story
**As a** 平台开发者,
**I want** 实现基于Cloudflare R2的多用户访问控制和目录隔离机制,
**so that** 每个用户都可以拥有专属的同步凭证和安全的文件存储空间，确保数据完全隔离

## Acceptance Criteria
- [ ] 实现用户专属R2访问路径的自动创建和管理
- [ ] 支持为每个用户生成独立的API访问凭证
- [ ] 确保用户只能访问自己的目录和文件
- [ ] 提供灵活的访问控制策略（路径前缀隔离、自定义Token等）
- [ ] 实现高性能的访问控制代理层
- [ ] 支持凭证的自动过期、刷新和撤销机制
- [ ] 提供完整的访问审计日志和监控功能
- [ ] 确保与现有Obsidian同步插件的完美兼容

## Tasks / Subtasks
- [ ] Task 1: 设计多用户访问控制架构 (AC: 1, 3, 4, 7)
  - [ ] 设计基于路径前缀的隔离策略（不使用独立Bucket）
  - [ ] 设计用户访问路径的命名规范和结构（user-{userId}/格式）
  - [ ] 创建访问控制权限模型
  - [ ] 设计凭证生命周期管理机制
  - [ ] 集成用户注册流程，自动生成用户专属key和路径
- [ ] Task 2: 实现访问控制代理服务 (AC: 1, 3, 5, 7)
  - [ ] 开发Cloudflare Worker作为访问控制层
  - [ ] 实现路径重写和权限验证逻辑
  - [ ] 集成用户认证和token验证
  - [ ] 实现请求代理和响应处理
- [ ] Task 3: 开发用户凭证管理系统 (AC: 2, 4, 6, 7)
  - [ ] 实现用户专属token的生成和存储
  - [ ] 创建token权限范围限制机制
  - [ ] 开发凭证过期和自动刷新功能
  - [ ] 实现凭证撤销和黑名单机制
- [ ] Task 4: 集成R2存储服务 (AC: 1, 3, 5, 8)
  - [ ] 配置R2 Bucket以支持多用户访问
  - [ ] 实现用户目录的自动创建和管理
  - [ ] 集成文件上传和下载的访问控制
  - [ ] 测试大规模用户并发访问性能
- [ ] Task 5: 开发管理和监控接口 (AC: 6, 7, 8)
  - [ ] 创建访问日志记录和分析系统
  - [ ] 实现监控指标和报警机制
  - [ ] 开发管理接口用于用户和凭证管理
  - [ ] 提供使用统计和性能报告

## Dev Notes

### 技术架构信息
- **访问控制**: Cloudflare Worker代理层 + JWT Token验证
- **存储策略**: 单一R2 Bucket + 路径前缀隔离（唯一方案，不使用独立Bucket）
- **认证机制**: JWT Token + 权限范围限制
- **代理服务**: Cloudflare Worker作为中间访问层
- **数据隔离**: 用户专属路径前缀（user-{userId}/）+ 权限验证
- **自动生成**: 用户注册时自动生成专属key和路径（集成到注册流程）
- **监控**: 完整的访问日志 + 性能监控

### 数据模型信息
```typescript
// 用户R2访问配置
interface UserR2Access {
  id: string;
  userId: string;
  pathPrefix: string; // 用户专属路径，如 "user-123/"
  accessKeyId: string;
  secretAccessKey: string;
  permissions: R2Permission[];
  isActive: boolean;
  expiresAt?: Date;
  lastUsedAt?: Date;
  totalUsageBytes: number;
  fileCount: number;
  createdAt: Date;
  updatedAt: Date;
}

// R2权限定义
interface R2Permission {
  resource: string; // 资源路径模式，如 "user-123/*"
  actions: ('read' | 'write' | 'delete' | 'list')[];
  conditions?: Record<string, any>;
}

// 访问控制日志
interface AccessLog {
  id: string;
  userId: string;
  accessId: string;
  operation: 'read' | 'write' | 'delete' | 'list';
  resourcePath: string;
  ipAddress: string;
  userAgent: string;
  statusCode: number;
  responseTime: number;
  bytesTransferred: number;
  timestamp: Date;
}

// 用户目录配额
interface UserDirectoryQuota {
  userId: string;
  maxStorageBytes: number;
  maxFileCount: number;
  currentStorageBytes: number;
  currentFileCount: number;
  lastUpdated: Date;
}
```

### API规范信息
```typescript
// 用户访问控制API
interface UserAccessAPI {
  // 获取用户R2访问配置
  GET /api/user/r2-access: {
    response: { access: UserR2Access };
  }
  
  // 创建用户专属访问凭证
  POST /api/user/r2-access: {
    body: { 
      permissions?: R2Permission[];
      expiresInSeconds?: number;
    };
    response: { access: UserR2Access };
  }
  
  // 刷新用户访问凭证
  PUT /api/user/r2-access/refresh: {
    response: { access: UserR2Access };
  }
  
  // 撤销用户访问凭证
  DELETE /api/user/r2-access: {
    response: { success: boolean };
  }
  
  // 获取用户访问统计
  GET /api/user/r2-access/statistics: {
    response: { 
      usage: AccessStatistics;
      logs: AccessLog[];
    };
  }
}

// 管理员API
interface AdminAccessAPI {
  // 获取所有用户访问配置
  GET /api/admin/r2-access: {
    query: { page?: number; limit?: number; userId?: string };
    response: { accesses: UserR2Access[]; total: number };
  }
  
  // 获取系统访问统计
  GET /api/admin/r2-access/statistics: {
    response: { system: SystemStatistics };
  }
  
  // 管理用户访问权限
  PUT /api/admin/r2-access/:userId: {
    body: { permissions: R2Permission[]; isActive: boolean };
    response: { access: UserR2Access };
  }
}
```

### 技术栈信息
- **代理层**: Cloudflare Workers (付费版) with TypeScript
- **后端框架**: Hono.js 4.4 with TypeScript [Source: architecture.md#3]
- **数据库**: Cloudflare D1 with Drizzle ORM [Source: architecture.md#3]
- **对象存储**: Cloudflare R2
- **认证**: JWT Tokens + 权限范围限制
- **加密**: 使用Cloudflare Workers加密API
- **监控**: Cloudflare Analytics + 自定义指标
- **队列服务**: Cloudflare Queues (付费版) 用于异步处理
- **触发器**: Cloudflare Cron Triggers (付费版) 支持定时任务

### 文件路径和命名约定
- Worker代理: `/backend/workers/access-control-worker.ts`
- 后端API: `/backend/src/routes/`
  - `user-access.ts` - 用户访问控制API
  - `admin-access.ts` - 管理员访问控制API
- 服务层: `/backend/src/services/`
  - `access-control.service.ts` - 访问控制服务
  - `token-generator.service.ts` - Token生成服务
  - `quota-management.service.ts` - 配额管理服务
- 数据库: `/backend/src/db/schema.ts` (扩展)
- 工具库: `/backend/src/utils/`
  - `path-validator.ts` - 路径验证工具
  - `permission-checker.ts` - 权限检查工具
- 配置: `/backend/src/config/access-control.config.ts`

### 技术约束
- 必须确保用户数据完全隔离，不得出现跨用户访问
- 必须支持高并发的文件访问和上传下载
- 必须实现高效的权限验证和路径重写
- 必须提供完整的访问审计和监控功能
- 必须与现有Obsidian同步插件完全兼容
- 付费版Cloudflare Workers支持：默认30秒CPU时间（可配置最长5分钟）、Cloudflare Queues、250个Cron触发器
- Cron触发器最长支持15分钟CPU时间，完全满足LLM调用需求
- 必须充分利用付费版特性实现高性能和高可靠性

## Testing

### 测试标准
- 用户目录隔离完全有效，无跨用户访问风险
- 访问控制性能满足要求（响应时间 < 100ms）
- 凭证生成和验证机制安全可靠
- 权限控制和路径重写逻辑正确
- 访问日志记录完整准确
- 大规模并发访问稳定可靠
- 与Obsidian同步插件兼容性良好

### 测试框架和模式
- **单元测试**: 使用Vitest测试权限验证和业务逻辑
- **集成测试**: 使用Playwright测试完整的访问控制流程
- **安全测试**: 使用安全测试工具验证访问控制有效性
- **性能测试**: 测试大规模并发访问的性能表现
- **兼容性测试**: 测试与Obsidian插件的集成效果

### 测试用例示例
```typescript
// 访问控制服务测试示例
describe('Access Control Service', () => {
  it('should create user-specific access configuration', async () => {
    const service = new AccessControlService();
    const access = await service.createUserAccess(testUserId, {
      permissions: ['read', 'write'],
      expiresInSeconds: 86400 // 24小时
    });
    
    expect(access.userId).toBe(testUserId);
    expect(access.pathPrefix).toContain(testUserId);
    expect(access.permissions).toContainEqual(expect.objectContaining({
      resource: `user-${testUserId}/*`,
      actions: ['read', 'write']
    }));
  });

  it('should validate path access permissions', async () => {
    const service = new AccessControlService();
    const hasAccess = await service.validatePathAccess(
      testUserId, 
      'user-123/news/2024/01/article.md',
      'read'
    );
    
    expect(hasAccess).toBe(true);
  });

  it('should prevent cross-user access', async () => {
    const service = new AccessControlService();
    const hasAccess = await service.validatePathAccess(
      testUserId, 
      'user-456/news/2024/01/article.md', // 其他用户路径
      'read'
    );
    
    expect(hasAccess).toBe(false);
  });
});
```

### Worker代理测试示例
```typescript
// Worker访问控制测试
describe('Access Control Worker', () => {
  it('should proxy authorized requests', async () => {
    const worker = new AccessControlWorker();
    const request = new Request('https://worker.dev/user-123/test.txt', {
      headers: { 'Authorization': 'Bearer valid-token' }
    });
    
    const response = await worker.handleRequest(request);
    expect(response.status).toBe(200);
  });

  it('should block unauthorized access', async () => {
    const worker = new AccessControlWorker();
    const request = new Request('https://worker.dev/user-456/test.txt', {
      headers: { 'Authorization': 'Bearer user-123-token' }
    });
    
    const response = await worker.handleRequest(request);
    expect(response.status).toBe(403);
  });
});
```

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-14 | 1.0 | Initial draft | Development Team |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. 待开发 - 分析和设计多用户访问控制架构
2. 待开发 - 实现Cloudflare Worker代理服务
3. 待开发 - 开发用户凭证管理系统
4. 待开发 - 集成R2存储和路径隔离
5. 待开发 - 实现访问监控和日志系统
6. 待开发 - 性能优化和大规模测试
7. 待开发 - 与Obsidian插件集成测试
8. 待开发 - 安全性验证和审计

### Completion Notes List
1. 待开发 - 完成架构设计和技术选型
2. 待开发 - 实现Worker代理层和权限控制
3. 待开发 - 开发用户凭证生成和管理系统
4. 待开发 - 集成R2存储和目录隔离
5. 待开发 - 实现监控和日志系统
6. 待开发 - 性能优化和压力测试
7. 待开发 - 完成与Obsidian插件集成
8. 待开发 - 安全审计和部署准备

### File List
- 待创建 - `/backend/workers/access-control-worker.ts`
- 待创建 - `/backend/src/routes/user-access.ts`
- 待创建 - `/backend/src/routes/admin-access.ts`
- 待创建 - `/backend/src/services/access-control.service.ts`
- 待创建 - `/backend/src/services/token-generator.service.ts`
- 待创建 - `/backend/src/services/quota-management.service.ts`
- 待创建 - `/backend/src/utils/path-validator.ts`
- 待创建 - `/backend/src/utils/permission-checker.ts`
- 待更新 - `/backend/src/db/schema.ts` (添加访问控制相关表)
- 待创建 - `/backend/src/config/access-control.config.ts`
- 待创建 - `/backend/src/db/migrations/2025-09-14-add-multiuser-r2-access.sql`

### Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-14 | 1.0 | Initial draft | Development Team |

## QA Results
### QA Agent Used
待定

### QA Checklist
- [ ] 用户目录隔离完全有效
- [ ] 访问控制性能满足要求
- [ ] 凭证生成和验证机制安全可靠
- [ ] 权限控制和路径重写逻辑正确
- [ ] 访问日志记录完整准确
- [ ] 大规模并发访问稳定可靠
- [ ] 与Obsidian同步插件兼容性良好
- [ ] 安全性测试通过
- [ ] 性能测试通过
- [ ] 用户体验测试通过

### QA Notes
待执行QA测试...

### QA Status
待开发 - Pending Development