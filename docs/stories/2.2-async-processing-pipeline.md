# Story 2.2: 异步处理管道搭建

## Status
Ready for Review

## Story
**As a** 开发者,
**I want** 搭建起"生产者-队列-消费者"的完整异步处理管道,
**so that** 系统可以高效、可靠地处理RSS内容，避免阻塞主线程并提供容错能力

## Acceptance Criteria
- [x] 实现生产者（Producer）模块，负责将RSS处理任务发送到队列
- [x] 配置Cloudflare Queues作为消息队列服务
- [x] 实现消费者（Consumer）模块，负责从队列中接收并处理任务
- [x] 确保处理管道具备重试机制和错误处理能力
- [x] 实现消息的持久化存储，防止消息丢失
- [x] 支持消息处理状态的跟踪和监控
- [x] 确保管道在高负载情况下的稳定性和性能

## Tasks / Subtasks
- [x] Task 1: 配置Cloudflare Queues (AC: 2, 5)
  - [x] 在wrangler.jsonc中配置队列绑定
  - [x] 创建RSS处理队列（RSS_PROCESSOR_QUEUE）
  - [x] 创建AI处理队列（AI_PROCESSOR_QUEUE）
  - [x] 配置队列的重试策略和死信队列
- [x] Task 2: 实现生产者模块 (AC: 1, 5)
  - [x] 创建QueueProducer服务类
  - [x] 实现消息序列化和发送逻辑
  - [x] 添加消息验证和错误处理
  - [x] 集成到RSS获取流程中
- [x] Task 3: 实现消费者模块 (AC: 3, 4, 6)
  - [x] 创建QueueConsumer服务类
  - [x] 实现消息接收和处理逻辑
  - [x] 添加消息确认和重试机制
  - [x] 实现处理状态跟踪
- [x] Task 4: 集成处理管道 (AC: 1, 3, 7)
  - [x] 将生产者集成到RSS获取Worker中
  - [x] 将消费者集成到AI处理Worker中
  - [x] 实现端到端的消息流转测试
  - [x] 性能测试和优化
- [x] Task 5: 监控和日志 (AC: 6, 7)
  - [x] 实现队列监控指标
  - [x] 添加详细的处理日志
  - [x] 创建队列管理接口
  - [x] 实现警报和通知机制

## Dev Notes

### 技术架构信息
- **队列服务**: Cloudflare Queues [Source: architecture.md#3]
- **消息模式**: Producer-Consumer模式
- **重试机制**: 指数退避重试策略
- **错误处理**: 死信队列（DLQ）处理失败消息
- **监控**: 内置队列指标和自定义监控

### 数据模型信息
```typescript
// 队列消息格式
interface QueueMessage {
  id: string;
  type: 'rss_fetch' | 'ai_process';
  payload: {
    sourceId: string;
    userId: string;
    url: string;
    title?: string;
    content?: string;
    metadata?: Record<string, any>;
  };
  timestamp: Date;
  attempts: number;
  maxRetries: number;
}

// 处理状态跟踪
interface ProcessingStatus {
  id: string;
  messageId: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  userId: string;
  sourceId: string;
  error?: string;
  startedAt?: Date;
  completedAt?: Date;
  retryCount: number;
}
```

### API规范信息
```typescript
// 队列生产者接口
interface QueueProducer {
  send(message: QueueMessage): Promise<void>;
  sendBatch(messages: QueueMessage[]): Promise<void>;
}

// 队列消费者接口
interface QueueConsumer {
  process(handler: (message: QueueMessage) => Promise<void>): Promise<void>;
  acknowledge(messageId: string): Promise<void>;
  retry(messageId: string): Promise<void>;
  deadLetter(messageId: string, error: string): Promise<void>;
}

// 队列监控接口
interface QueueMonitor {
  getQueueStats(): Promise<QueueStats>;
  getMessageHistory(messageId: string): Promise<MessageHistory[]>;
  getFailedMessages(): Promise<QueueMessage[]>;
}
```

### 技术栈信息
- **队列服务**: Cloudflare Queues
- **序列化**: JSON
- **后端框架**: Hono.js 4.4 with TypeScript [Source: architecture.md#3]
- **数据库**: Cloudflare D1 with Drizzle ORM [Source: architecture.md#3]
- **监控**: Cloudflare Workers Metrics + 自定义指标

### 文件路径和命名约定
- 队列配置: `/backend/wrangler.jsonc` (更新)
- 队列服务: `/backend/src/services/queue/`
  - `producer.ts` - 生产者实现
  - `consumer.ts` - 消费者实现
  - `monitor.ts` - 监控实现
  - `types.ts` - 类型定义
- 队列Worker: `/backend/src/workers/`
  - `queue-consumer.ts` - 队列消费者Worker
- 集成点: `/backend/src/workers/rss-fetcher.ts` (集成生产者)
- 数据库schema: `/backend/src/db/schema.ts` (添加处理状态表)

### 技术约束
- 必须使用Cloudflare Queues作为消息队列服务
- 消息大小不能超过128KB (Cloudflare Queues限制)
- 处理时间不能超过30秒 (Cloudflare Workers限制)
- 必须实现幂等性处理，避免重复处理
- 必须实现适当的错误处理和重试机制

## Testing

### 测试标准
- 消息发送和接收功能正常
- 重试机制按预期工作
- 错误处理和死信队列功能正常
- 处理状态跟踪准确
- 性能满足系统要求
- 监控指标正确收集

### 测试框架和模式
- **单元测试**: 使用Vitest测试队列组件
- **集成测试**: 使用Playwright测试端到端流程
- **性能测试**: 使用k6进行负载测试
- **错误测试**: 故障注入和恢复测试

### 测试用例示例
```typescript
// 队列测试示例
describe('Queue Processing Pipeline', () => {
  it('should send and receive messages', async () => {
    const producer = new QueueProducer();
    const consumer = new QueueConsumer();
    
    await producer.send(testMessage);
    const receivedMessage = await consumer.waitForMessage();
    
    expect(receivedMessage).toEqual(testMessage);
  });

  it('should retry failed messages', async () => {
    const failingHandler = vi.fn().mockRejectedValue(new Error('Test error'));
    await consumer.process(failingHandler);
    
    await producer.send(testMessage);
    await sleep(5000); // 等待重试
    
    expect(failingHandler).toHaveBeenCalledTimes(3); // 最大重试次数
  });
});
```

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. ✅ 已完成 - 配置Cloudflare Queues和wrangler.jsonc
2. ✅ 已完成 - 实现QueueProducer服务类
3. ✅ 已完成 - 实现QueueConsumer服务类
4. ✅ 已完成 - 集成到现有RSS获取和AI处理流程
5. ✅ 已完成 - 实现监控和日志系统
6. ✅ 已完成 - 性能测试和优化

### Completion Notes List
1. ✅ 已完成 - Cloudflare Queues配置和绑定
2. ✅ 已完成 - 生产者模块实现
3. ✅ 已完成 - 消费者模块实现
4. ✅ 已完成 - 重试机制和错误处理
5. ✅ 已完成 - 处理状态跟踪
6. ✅ 已完成 - 监控和日志系统
7. ✅ 已完成 - 端到端集成测试
8. ✅ 已完成 - 性能优化

### File List
- `/backend/wrangler.jsonc` (已更新) - 添加队列配置
- `/backend/src/services/queue/producer.ts` (已创建) - 队列生产者服务
- `/backend/src/services/queue/consumer.ts` (已创建) - 队列消费者服务
- `/backend/src/services/queue/monitor.ts` (已创建) - 队列监控服务
- `/backend/src/services/queue/types.ts` (已创建) - 队列类型定义
- `/backend/src/workers/queue-consumer.ts` (已创建) - 队列消费者Worker
- `/backend/src/workers/rss-fetcher.ts` (已更新) - 集成队列生产者
- `/backend/src/workers/ai-processor.ts` (已更新) - 集成队列消费者
- `/backend/src/db/schema.ts` (已更新) - 添加处理状态跟踪表
- `/backend/src/db/migrations/2025-09-08-add-queue-processing-tables.sql` (已创建) - 数据库迁移
- `/backend/test/queue.test.ts` (已创建) - 队列测试
- `/backend/vitest.config.ts` (已创建) - 测试配置
- `/backend/package.json` (已更新) - 添加测试脚本

### Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |
| 2025-09-08 | 2.0 | 实现完整的异步处理管道 | James (Dev Agent) |

## QA Results
### QA Agent Used
待定

### QA Checklist
- [ ] Cloudflare Queues配置正确
- [ ] 生产者模块功能完整
- [ ] 消费者模块功能完整
- [ ] 重试机制正常工作
- [ ] 错误处理和死信队列功能正常
- [ ] 处理状态跟踪准确
- [ ] 监控指标正确收集
- [ ] 端到端流程测试通过
- [ ] 性能满足系统要求
- [ ] 文档完整准确

### QA Notes
待开发完成后的QA测试记录

### QA Status
开发完成 - 已提交代码，等待QA