# Story 4.3: 系统监控面板

## Status
Not Started

## Story
**As a** 平台管理员,
**I want** 查看系统运行状态和关键指标,
**so that** 我可以及时发现问题并采取相应的运维措施

## Acceptance Criteria
- [ ] 创建系统概览仪表盘，显示关键运行指标
- [ ] 实现实时系统性能监控（CPU、内存、网络等）
- [ ] 提供服务健康状态检查和异常报警
- [ ] 显示队列处理状态和积压情况
- [ ] 提供数据库性能和连接状态监控
- [ ] 实现用户活动统计和行为分析
- [ ] 支持监控数据的导出和历史趋势分析

## Tasks / Subtasks
- [ ] Task 1: 设计监控系统数据模型 (AC: 1, 6)
  - [ ] 创建系统指标收集表结构
  - [ ] 设计性能指标存储模型
  - [ ] 实现健康检查状态跟踪
  - [ ] 创建统计数据聚合机制
- [ ] Task 2: 实现监控数据收集 (AC: 1, 2, 3, 4, 5)
  - [ ] 创建系统指标收集服务
  - [ ] 实现服务健康检查机制
  - [ ] 开发队列状态监控功能
  - [ ] 集成数据库性能监控
  - [ ] 实现用户活动统计收集
- [ ] Task 3: 开发监控API (AC: 1, 2, 3, 4, 5, 7)
  - [ ] 创建系统指标查询API
  - [ ] 实现实时数据推送API
  - [ ] 添加健康检查API
  - [ ] 实现统计数据计算API
  - [ ] 创建数据导出API
  - [ ] 实现报警规则管理API
- [ ] Task 4: 创建监控仪表盘界面 (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 开发系统概览面板
  - [ ] 实现实时性能监控图表
  - [ ] 创建服务健康状态展示
  - [ ] 开发队列状态监控组件
  - [ ] 实现用户活动统计图表
  - [ ] 创建数据导出和历史趋势分析功能
- [ ] Task 5: 实现报警和通知 (AC: 3, 7)
  - [ ] 创建报警规则管理功能
  - [ ] 实现报警触发和通知机制
  - [ ] 开发报警历史记录查看
  - [ ] 实现报警级别和升级机制
  - [ ] 集成邮件和短信通知

## Dev Notes

### 技术架构信息
- **监控系统**: 分布式指标收集和实时监控
- **数据存储**: 时序数据库或优化的关系型数据库存储
- **实时通信**: WebSocket或Server-Sent Events用于实时数据推送
- **图表展示**: 基于Chart.js或Recharts的动态图表
- **报警系统**: 规则引擎和多通道通知

### 数据模型信息
```typescript
// 系统性能指标
interface SystemMetrics {
  id: string;
  timestamp: Date;
  service: string;
  cpu_usage: number; // 0-100%
  memory_usage: number; // MB
  disk_usage: number; // MB
  network_in: number; // bytes
  network_out: number; // bytes;
  response_time: number; // ms
  error_rate: number; // 0-100%
  active_connections: number;
}

// 服务健康状态
interface ServiceHealth {
  id: string;
  service_name: string;
  status: 'healthy' | 'degraded' | 'unhealthy';
  last_check: Date;
  response_time: number;
  error_message?: string;
  consecutive_failures: number;
  uptime: number; // seconds
}

// 队列处理状态
interface QueueStatus {
  id: string;
  queue_name: string;
  pending_messages: number;
  processing_messages: number;
  failed_messages: number;
  completed_messages: number;
  avg_processing_time: number; // ms
  last_processed: Date;
  throughput: number; // messages/min
}

// 用户活动统计
interface UserActivityStats {
  id: string;
  date: Date;
  total_users: number;
  active_users: number;
  new_users: number;
  sessions_count: number;
  page_views: number;
  avg_session_duration: number; // seconds
  top_actions: Array<{
    action: string;
    count: number;
  }>;
}

// 报警规则和记录
interface AlertRule {
  id: string;
  name: string;
  metric: string;
  condition: 'gt' | 'lt' | 'eq' | 'ne';
  threshold: number;
  duration: number; // seconds
  severity: 'low' | 'medium' | 'high' | 'critical';
  enabled: boolean;
  notification_channels: string[];
  created_at: Date;
  updated_at: Date;
}

interface AlertRecord {
  id: string;
  rule_id: string;
  triggered_at: Date;
  resolved_at?: Date;
  value: number;
  message: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  status: 'active' | 'resolved';
  notifications_sent: string[];
}
```

### API规范信息
```typescript
// 系统监控API
interface MonitoringAPI {
  // 获取系统概览指标
  GET /api/admin/monitoring/overview: {
    response: {
      system: SystemMetrics;
      services: ServiceHealth[];
      queues: QueueStatus[];
      users: UserActivityStats;
      alerts: AlertRecord[];
    };
  }
  
  // 获取性能指标历史
  GET /api/admin/monitoring/metrics: {
    query: {
      service?: string;
      start_time: string;
      end_time: string;
      interval: '1m' | '5m' | '15m' | '1h' | '1d';
    };
    response: { metrics: SystemMetrics[] };
  }
  
  // 获取服务健康状态
  GET /api/admin/monitoring/health: {
    response: { services: ServiceHealth[] };
  }
  
  // 获取队列状态
  GET /api/admin/monitoring/queues: {
    response: { queues: QueueStatus[] };
  }
  
  // 获取用户活动统计
  GET /api/admin/monitoring/users: {
    query: { period: 'today' | 'week' | 'month' };
    response: { stats: UserActivityStats[] };
  }
  
  // 管理报警规则
  GET /api/admin/monitoring/alerts/rules: { response: { rules: AlertRule[] } }
  POST /api/admin/monitoring/alerts/rules: { body: AlertRule; response: { rule: AlertRule } }
  PUT /api/admin/monitoring/alerts/rules/:id: { body: Partial<AlertRule>; response: { rule: AlertRule } }
  
  // 获取报警记录
  GET /api/admin/monitoring/alerts/history: {
    query: { status?: 'active' | 'resolved'; limit?: number };
    response: { alerts: AlertRecord[] };
  }
  
  // 导出监控数据
  GET /api/admin/monitoring/export: {
    query: { 
      type: 'metrics' | 'health' | 'queues' | 'users';
      start_time: string;
      end_time: string;
      format: 'csv' | 'json';
    };
    response: { data: any; filename: string };
  }
}
```

### 技术栈信息
- **后端框架**: Hono.js 4.4 with TypeScript [Source: architecture.md#3]
- **数据库**: Cloudflare D1 with Drizzle ORM [Source: architecture.md#3]
- **前端框架**: Amis (基于React的低代码框架) [Source: Story 4.1]
- **图表库**: Chart.js 或 Recharts
- **实时通信**: WebSocket或Server-Sent Events
- **样式**: Amis内置样式系统
- **构建工具**: Vite

### 文件路径和命名约定
- 监控服务: `/backend/src/services/monitoring/`
  - `metrics-collector.service.ts` - 指标收集服务
  - `health-check.service.ts` - 健康检查服务
  - `queue-monitor.service.ts` - 队列监控服务
  - `user-stats.service.ts` - 用户统计服务
  - `alert-engine.service.ts` - 报警引擎服务
- 监控API: `/backend/src/routes/admin/monitoring.ts`
- 管理后台页面: `/admin/src/pages/monitoring/`
  - `overview.tsx` - 监控概览页面
  - `metrics.tsx` - 性能指标页面
  - `health.tsx` - 健康状态页面
  - `queues.tsx` - 队列状态页面
  - `users.tsx` - 用户统计页面
  - `alerts.tsx` - 报警管理页面
- 监控组件: `/admin/src/components/monitoring/`
  - `MetricsChart.tsx` - 指标图表组件
  - `HealthStatus.tsx` - 健康状态组件
  - `QueueStatus.tsx` - 队列状态组件
  - `AlertManager.tsx` - 报警管理组件
  - `RealTimeMetrics.tsx` - 实时指标组件
- 数据库: `/backend/src/db/schema.ts` (扩展)

### 技术约束
- 监控数据收集必须轻量且高效
- 实时数据推送延迟必须小于5秒
- 报警触发必须准确且及时
- 监控界面必须响应迅速且直观
- 必须支持大规模数据的存储和查询

## Testing

### 测试标准
- 系统指标收集准确且完整
- 健康检查功能正常工作
- 队列状态监控准确反映实际状态
- 用户活动统计数据正确
- 报警系统触发及时且准确
- 监控界面数据展示正确
- 实时数据推送稳定可靠
- 数据导出功能正常

### 测试框架和模式
- **单元测试**: 使用Vitest测试监控业务逻辑
- **集成测试**: 使用Playwright测试监控界面功能
- **实时测试**: 测试实时数据推送和更新
- **性能测试**: 测试监控系统的性能和资源消耗

### 测试用例示例
```typescript
// 监控API测试示例
describe('System Monitoring API', () => {
  it('should return system overview metrics', async () => {
    const adminToken = await getAdminToken();
    const response = await request(app)
      .get('/api/admin/monitoring/overview')
      .set('Authorization', `Bearer ${adminToken}`);
    
    expect(response.status).toBe(200);
    expect(response.body.system).toBeDefined();
    expect(response.body.services).toBeDefined();
    expect(response.body.queues).toBeDefined();
    expect(response.body.users).toBeDefined();
  });

  it('should track service health status', async () => {
    const service = await createMockService('unhealthy');
    const healthService = new HealthCheckService();
    const health = await healthService.checkService(service.name);
    
    expect(health.status).toBe('unhealthy');
    expect(health.error_message).toBeDefined();
  });

  it('should trigger alerts when thresholds exceeded', async () => {
    const alertRule = await createAlertRule({
      metric: 'cpu_usage',
      condition: 'gt',
      threshold: 80,
      duration: 300
    });
    
    await simulateHighCpuUsage(90);
    const alerts = await getActiveAlerts();
    
    expect(alerts.some(alert => alert.rule_id === alertRule.id)).toBe(true);
  });
});
```

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4

### Debug Log References
1. 待开发 - 设计监控系统数据模型
2. 待开发 - 实现监控数据收集服务
3. 待开发 - 开发监控API端点
4. 待开发 - 创建监控仪表盘界面
5. 待开发 - 实现报警和通知系统
6. 待开发 - 集成实时数据推送
7. 待开发 - 实现数据导出和历史分析

### Completion Notes List
1. 待完成 - 监控系统数据模型设计
2. 待完成 - 监控数据收集服务实现
3. 待完成 - 监控API端点开发
4. 待完成 - 监控仪表盘界面开发
5. 待完成 - 报警规则引擎实现
6. 待完成 - 实时数据推送集成
7. 待完成 - 健康检查机制实现
8. 待完成 - 数据导出功能实现

### File List
- `/backend/src/db/schema.ts` (待更新)
- `/backend/src/routes/admin/monitoring.ts` (待创建)
- `/backend/src/services/monitoring/metrics-collector.service.ts` (待创建)
- `/backend/src/services/monitoring/health-check.service.ts` (待创建)
- `/backend/src/services/monitoring/queue-monitor.service.ts` (待创建)
- `/backend/src/services/monitoring/user-stats.service.ts` (待创建)
- `/backend/src/services/monitoring/alert-engine.service.ts` (待创建)
- `/admin/src/pages/monitoring/overview.tsx` (待创建)
- `/admin/src/components/monitoring/MetricsChart.tsx` (待创建)
- `/admin/src/components/monitoring/HealthStatus.tsx` (待创建)
- `/admin/src/components/monitoring/AlertManager.tsx` (待创建)

### Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-08 | 1.0 | Initial draft | Product Manager |

## QA Results
### QA Agent Used
待定

### QA Checklist
- [ ] 系统指标收集准确且完整
- [ ] 健康检查功能正常工作
- [ ] 队列状态监控准确反映实际状态
- [ ] 用户活动统计数据正确
- [ ] 报警系统触发及时且准确
- [ ] 监控界面数据展示正确
- [ ] 实时数据推送稳定可靠
- [ ] 数据导出功能正常
- [ ] 性能测试通过
- [ ] 用户体验测试通过

### QA Notes
待开发完成后的QA测试记录

### QA Status
待开发 - Not Started