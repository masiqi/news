# WebDAV服务使用指南

## 概述

WebDAV服务为用户提供了一个基于标准WebDAV协议的文件存储接口，用户可以通过WebDAV客户端（如操作系统原生支持、第三方客户端等）访问其在Cloudflare R2中的个人文件存储空间。

## 功能特性

- 🔐 **用户认证**: 使用HTTP Basic Auth，支持用户名密码登录
- 🗂️ **用户隔离**: 每个用户拥有独立的存储空间，严格隔离
- 📁 **目录操作**: 支持创建、删除、列出目录
- 📄 **文件操作**: 支持上传、下载、删除、移动、复制文件
- 🔒 **安全控制**: 防止路径遍历攻击，确保数据安全
- 📊 **标准协议**: 完全兼容WebDAV协议

## 接入方式

### 服务地址
```
https://your-domain.com/webdav/
```

### 认证方式
使用HTTP Basic Auth认证：
- **用户名**: 用户的邮箱地址
- **密码**: 用户的登录密码

### 支持的WebDAV方法
- `PROPFIND`: 列出目录内容或获取文件属性
- `GET`: 下载文件
- `PUT`: 上传文件
- `DELETE`: 删除文件或目录
- `MKCOL`: 创建目录
- `MOVE`: 移动文件或目录
- `COPY`: 复制文件或目录
- `OPTIONS`: 获取服务器支持的功能

## 使用示例

### Windows文件资源管理器

1. 打开文件资源管理器
2. 右键点击"此电脑"，选择"添加一个网络位置"
3. 点击"下一步"，选择"选择自定义网络位置"
4. 输入WebDAV地址：`https://your-domain.com/webdav/`
5. 取消勾选"使用其他凭据登录"
6. 输入用户名（邮箱）和密码
7. 完成设置

### macOS Finder

1. 打开Finder
2. 选择"前往" → "连接服务器"
3. 输入服务器地址：`https://your-domain.com/webdav/`
4. 点击"连接"
5. 输入用户名和密码
6. 选择"注册的用户"

### Linux (Nautilus/Dolphin)

1. 打开文件管理器
2. 按 `Ctrl+L` 打开地址栏
3. 输入：`davs://your-domain.com/webdav/`
4. 按回车，输入用户名和密码

### 命令行工具 (cadaver)

```bash
# 安装cadaver
sudo apt-get install cadaver

# 连接WebDAV服务器
cadaver https://your-domain.com/webdav/

# 输入用户名和密码后可以使用命令：
ls          # 列出当前目录
mkdir test   # 创建目录
put file.txt # 上传文件
get file.txt # 下载文件
delete file.txt # 删除文件
```

### 第三方客户端

- **Cyberduck**: 跨平台WebDAV客户端
- **Mountain Duck**: 商业WebDAV客户端
- **FileZilla**: 支持WebDAV协议
- **GoodSync**: 文件同步工具

## 用户存储空间

### 路径结构
每个用户的文件存储在独立的路径下：
```
user-{userId}/
├── documents/     # 文档目录
├── notes/         # 笔记目录  
├── exports/       # 导出目录
└── config/        # 配置目录
```

### 访问权限
- ✅ 用户只能访问自己的存储空间
- ❌ 无法访问其他用户的文件
- ❌ 无法进行路径遍历攻击
- ✅ 支持子目录和嵌套结构

## 错误处理

### 常见错误码
- `401 Unauthorized`: 认证失败，检查用户名密码
- `403 Forbidden`: 权限不足，路径不在用户范围内
- `404 Not Found`: 文件或目录不存在
- `409 Conflict`: 目标路径已存在
- `500 Internal Server Error`: 服务器内部错误

### 解决方案
1. 检查用户名和密码是否正确
2. 确认用户账户状态为活跃
3. 检查WebDAV服务是否正常运行
4. 查看服务器日志获取详细错误信息

## 安全特性

### 认证安全
- 使用HTTP Basic Auth + 用户系统
- 密码使用SHA-256 + 盐值哈希存储
- 支持账户状态管理（活跃/暂停等）

### 访问控制
- 严格的路径前缀验证
- 防止路径遍历攻击 (`../`)
- 用户空间完全隔离

### 数据传输
- 建议使用HTTPS加密传输
- 支持ETag进行文件完整性验证
- 支持断点续传

## 性能优化

### 分页支持
- 大目录支持分页列出
- 游标分页，避免内存溢出
- 默认限制1000个项目

### 缓存机制
- R2对象元数据缓存
- 目录列表缓存
- 减少重复的R2请求

## 监控和日志

### 日志格式
```
[WEBDAV_AUTH] 认证成功，用户ID: 1, 路径前缀: user-1/
[WEBDAV_SERVICE] 列出目录完成，找到15个项目
[WEBDAV] GET 成功: /documents/file.txt, 大小: 1024字节
```

### 监控指标
- 认证成功率
- 文件操作次数
- 错误率统计
- 存储空间使用情况

## 故障排除

### 连接问题
1. 检查网络连接
2. 确认域名和端口正确
3. 检查防火墙设置
4. 验证SSL证书

### 认证问题
1. 确认用户名是邮箱地址
2. 检查密码是否正确
3. 确认用户账户状态
4. 重置用户密码

### 操作问题
1. 检查文件路径是否正确
2. 确认有足够权限
3. 检查磁盘空间
4. 查看服务器日志

## 开发和测试

### 测试脚本
运行测试脚本验证功能：
```bash
cd backend
node test-webdav.mjs
```

### 单元测试
```bash
npm test
```

### 集成测试
使用WebDAV客户端进行端到端测试。

## 未来扩展

### 计划功能
- [ ] 文件锁定支持
- [ ] 版本控制
- [ ] 搜索功能
- [ ] 共享功能
- [ ] 配额管理
- [ ] 垃圾回收

### 性能优化
- [ ] CDN集成
- [ ] 智能缓存
- [ ] 压缩传输
- [ ] 并发控制